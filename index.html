<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MediBase | Intranet</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Palette Inspired by Image */
            --bg-app: #f2f3f7;
            --bg-panel: #ffffff;
            
            --primary: #FF8F6B; /* Soft Coral */
            --primary-hover: #ff7b52;
            --primary-light: #fff0eb;
            
            --secondary: #6B9EFF; /* Soft Blue */
            --secondary-light: #eef5ff;
            
            --accent-teal: #4ECDC4;
            --accent-yellow: #FFE66D;
            --danger: #ff4757;
            
            --text-dark: #2d3436;
            --text-muted: #8395a7;
            
            --border: #f0f2f5;
            
            --shadow-soft: 0 10px 40px -10px rgba(0,0,0,0.05);
            --shadow-card: 0 4px 20px -5px rgba(0,0,0,0.03);
            
            --radius-xl: 24px;
            --radius-md: 16px;
            --radius-sm: 12px;

            /* Scope Colors */
            --scope-global: #a55eea;
            --scope-regional: #4b7bec;
            --scope-local: #20bf6b;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-font-smoothing: antialiased; }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-app);
            color: var(--text-dark);
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* --- SIDEBAR --- */
        .sidebar {
            width: 270px;
            background-color: var(--bg-app); /* Transparent feel */
            display: flex; flex-direction: column;
            padding: 2rem 1.5rem; flex-shrink: 0;
            overflow-y: auto;
        }

        .brand {
            color: var(--primary); font-size: 1.5rem; font-weight: 800;
            display: flex; align-items: center; gap: 10px; margin-bottom: 3rem;
            padding-left: 10px;
        }
        .brand span { color: var(--text-dark); }
        .logo-shape {
            width: 32px; height: 32px; background: var(--primary); 
            border-radius: 10px; transform: rotate(45deg); display: flex; align-items: center; justify-content: center;
        }
        .logo-shape::after { content:""; width: 14px; height: 14px; background: white; border-radius: 50%; }

        .menu-label {
            font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em;
            color: var(--text-muted); font-weight: 700; margin-bottom: 1rem; margin-top: 2rem;
            padding-left: 15px; opacity: 0.8;
        }

        .nav-btn {
            display: flex; align-items: center; gap: 14px; width: 100%;
            padding: 0.9rem 1.2rem; background: transparent; border: none;
            color: var(--text-muted); font-family: inherit; font-size: 0.95rem; font-weight: 600;
            cursor: pointer; border-radius: var(--radius-xl); transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
            text-align: left; margin-bottom: 8px; position: relative;
        }
        .nav-btn:hover { background: rgba(255,255,255,0.6); color: var(--primary); transform: translateX(5px); }
        .nav-btn.active { background: var(--primary); color: white; box-shadow: 0 10px 20px -5px rgba(255, 143, 107, 0.4); }
        .nav-btn svg { width: 20px; height: 20px; stroke-width: 2.5px; }

        .nav-btn.sub-item {
            padding-left: 2.8rem; padding-top: 0.6rem; padding-bottom: 0.6rem;
            font-size: 0.85rem; color: var(--text-muted); position: relative;
        }
        .nav-btn.sub-item::before {
            content:""; position: absolute; left: 1.8rem; top: 50%; width: 6px; height: 6px;
            background: #dcdde1; border-radius: 50%; transform: translateY(-50%);
        }
        .nav-btn.sub-item:hover { color: var(--primary); background: transparent; transform: translateX(5px); }
        .nav-btn.sub-item.active { color: var(--primary); background: transparent; box-shadow: none; }
        .nav-btn.sub-item.active::before { background: var(--primary); }

        .category-dot { width: 12px; height: 12px; border-radius: 6px; margin-right: 2px; }

        .admin-panel { margin-top: auto; padding-top: 2rem; }
        
        .notification-badge {
            background: var(--danger); color: white; font-size: 0.7rem; font-weight: 800;
            padding: 2px 6px; border-radius: 10px; position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
        }

        /* --- MAIN CONTENT --- */
        .main-content {
            flex: 1; display: flex; flex-direction: column;
            position: relative; overflow: hidden;
            background: var(--bg-panel);
            margin: 1rem 1rem 1rem 0;
            border-radius: 40px; /* Big rounding on the main panel */
            box-shadow: var(--shadow-soft);
            padding: 0;
        }

        /* HEADER */
        .top-header {
            height: 90px;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 2.5rem; flex-shrink: 0;
            background: var(--bg-panel);
            z-index: 10;
        }

        .header-title h2 { font-size: 1.5rem; font-weight: 700; color: var(--text-dark); }
        .header-title p { color: var(--text-muted); font-size: 0.9rem; margin-top: 4px; }

        .header-actions { display: flex; align-items: center; gap: 20px; }

        .search-container { position: relative; width: 300px; }
        .search-container svg { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: var(--primary); width: 18px; }
        .search-input {
            width: 100%; padding: 12px 20px 12px 20px; border-radius: 50px;
            border: 2px solid transparent; background: #f7f8fa;
            font-size: 0.9rem; font-weight: 500; color: var(--text-dark); transition: 0.2s;
        }
        .search-input:focus { background: white; border-color: var(--primary-light); box-shadow: 0 0 0 4px var(--primary-light); }

        .profile-btn {
            width: 45px; height: 45px; border-radius: 50%; overflow: hidden;
            border: 2px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.1); cursor: pointer;
        }
        .profile-btn img { width: 100%; height: 100%; object-fit: cover; }

        /* BUTTONS & UI ELEMENTS (Unified Design) */
        .btn-primary {
            background: var(--primary); color: white; padding: 0.8rem 1.5rem;
            border-radius: 50px; border: none; font-weight: 600;
            cursor: pointer; box-shadow: 0 5px 15px rgba(255, 143, 107, 0.3); transition: 0.2s;
            display: flex; align-items: center; justify-content: center; gap: 10px; font-size: 0.9rem;
            white-space: nowrap;
        }
        .btn-primary:hover { background: var(--primary-hover); transform: translateY(-2px); }

        .btn-secondary {
            background: var(--secondary-light); color: var(--secondary); padding: 0.6rem 1.2rem;
            border-radius: 12px; border: none; font-weight: 600; cursor: pointer; transition: 0.2s;
            white-space: nowrap;
        }
        .btn-secondary:hover { background: #dbeafe; }
        
        .btn-ghost {
            background: transparent; color: var(--text-muted); padding: 0.6rem 1.2rem;
            border-radius: 12px; border: 1px solid transparent; font-weight: 600; cursor: pointer; transition: 0.2s;
            white-space: nowrap;
        }
        .btn-ghost:hover { background: #f0f2f5; color: var(--text-dark); }

        .btn-icon {
            width: 32px; height: 32px; border-radius: 50%; border: none;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: 0.2s; background: #f1f2f6; color: var(--text-muted);
            font-size: 1rem;
        }
        .btn-icon:hover { background: #e2e8f0; color: var(--text-dark); }
        .btn-icon.danger { background: #fee2e2; color: #ef4444; }
        .btn-icon.danger:hover { background: #fecaca; }

        .scope-badge {
            font-size: 0.6rem; font-weight: 800; padding: 2px 6px; border-radius: 4px; color: white; margin-right: 5px;
            text-transform: uppercase; display: inline-block; vertical-align: middle;
        }
        .scope-global { background: var(--scope-global); }
        .scope-regional { background: var(--scope-regional); }
        .scope-local { background: var(--scope-local); }

        /* VIEWS CONTAINER */
        .view-container { flex: 1; overflow-y: auto; padding: 1rem 2.5rem 2.5rem 2.5rem; display: none; }
        .view-container.active-view { display: block; animation: fadeIn 0.4s cubic-bezier(0.2, 0.8, 0.2, 1); }

        /* DASHBOARD GRID */
        .dash-layout {
            display: grid;
            grid-template-columns: 1fr; /* Single column layout */
            gap: 2rem;
            height: 100%;
        }
        @media (max-width: 1200px) { .dash-layout { grid-template-columns: 1fr; } }

        .dash-main { display: flex; flex-direction: column; gap: 2rem; }
        .dash-side { display: flex; flex-direction: column; gap: 2rem; }

        /* STATS */
        .stats-container {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem;
        }
        .stat-card {
            background: white; padding: 1.5rem; border-radius: var(--radius-xl);
            box-shadow: var(--shadow-card); border: 1px solid var(--border);
            position: relative; overflow: hidden; transition: 0.2s;
        }
        .stat-card:hover { transform: translateY(-3px); }
        .stat-card::before { content: ""; position: absolute; top:0; left:0; width: 6px; height: 100%; background: var(--primary); }
        .stat-card.blue::before { background: var(--secondary); }
        .stat-card.teal::before { background: var(--accent-teal); }
        
        .stat-label { font-size: 0.8rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.5rem; }
        .stat-value { font-size: 2rem; font-weight: 800; color: var(--text-dark); }
        .stat-desc { font-size: 0.85rem; color: var(--text-muted); margin-top: 5px; }

        /* WIDGETS GRID (5 per row) */
        .pinned-stack {
            display: grid;
            grid-template-columns: repeat(8, 1fr); /* More columns for smaller widgets */
            gap: 0.5rem;
        }
        @media (max-width: 1400px) { .pinned-stack { grid-template-columns: repeat(6, 1fr); } }
        @media (max-width: 1100px) { .pinned-stack { grid-template-columns: repeat(5, 1fr); } }
        @media (max-width: 800px) { .pinned-stack { grid-template-columns: repeat(4, 1fr); } }

        .widget-card {
            background: white; border-radius: var(--radius-sm); padding: 0.4rem;
            box-shadow: var(--shadow-card); border: 1px solid var(--border);
            display: flex; flex-direction: column; /* Vertical layout */
            align-items: center; justify-content: center; text-align: center;
            cursor: pointer; transition: 0.2s; position: relative;
            aspect-ratio: 1 / 1.1; /* Square-ish aspect ratio */
        }
        .widget-card:hover { box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1); transform: translateY(-5px); border-color: transparent; }
        .widget-card.draggable { cursor: grab; }
        
        .widget-icon-box {
            width: 20px; height: 20px; border-radius: 6px; flex-shrink: 0;
            display: flex; align-items: center; justify-content: center;
            font-size: 0.7rem; font-weight: 700; margin-bottom: 4px; position: relative;
        }
        .w-color-1 { background: var(--primary-light); color: var(--primary); }
        .w-color-2 { background: var(--secondary-light); color: var(--secondary); }
        .w-color-3 { background: #e0f2f1; color: var(--accent-teal); }
        
        .widget-content { width: 100%; display: flex; flex-direction: column; align-items: center; }
        .widget-tag {
            display: inline-block; padding: 1px 4px; border-radius: 8px;
            font-size: 0.45rem; font-weight: 700; text-transform: uppercase;
            background: #f1f2f6; color: var(--text-muted); margin-bottom: 2px;
        }
        .widget-title { font-size: 0.6rem; font-weight: 700; color: var(--text-dark); margin-bottom: 2px; width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .widget-sub { font-size: 0.5rem; color: var(--text-muted); }
        
        /* Removed action arrow for compact view, click card itself */
        .widget-action { display: none; } 

        .widget-delete-btn {
            position: absolute; top: 3px; right: 3px; width: 14px; height: 14px;
            background: var(--danger); color: white; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 9px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 5;
            display: none; cursor: pointer;
        }
        body.admin-mode .widget-delete-btn { display: flex; }

        .link-widget { background: linear-gradient(135deg, var(--secondary), #4a80e6); border: none; color: white; }
        .link-widget .widget-title { color: white; }
        .link-widget .widget-sub { color: rgba(255,255,255,0.8); }
        .link-widget .widget-icon-box { background: rgba(255,255,255,0.2); color: white; }

        .add-widget-btn {
            border: 1px dashed #dcdde1; border-radius: var(--radius-sm);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: var(--text-muted); font-weight: 600; cursor: pointer;
            transition: 0.2s; background: #fdfdfd; gap: 2px; text-align: center;
            aspect-ratio: 1 / 1.1; font-size: 0.5rem;
        }
        .add-widget-btn span { font-size: 1rem; font-weight: 300; line-height: 1; }
        .add-widget-btn:hover { border-color: var(--primary); color: var(--primary); background: var(--primary-light); }

        /* INFO PANEL */
        .info-card {
            background: var(--secondary); color: white; border-radius: var(--radius-xl);
            padding: 1.5rem; position: relative; border: none; display: flex; flex-direction: column;
            box-shadow: var(--shadow-card); min-height: 200px;
        }
        .info-edit-btn {
            position: absolute; top: 1rem; right: 1rem;
            background: rgba(255,255,255,0.2); color: white; border: none;
            width: 32px; height: 32px; border-radius: 50%; display: none;
            align-items: center; justify-content: center; cursor: pointer;
        }
        .info-edit-btn:hover { background: rgba(255,255,255,0.3); }
        body.admin-mode .info-edit-btn { display: flex; }

        /* GRID VIEW (Articles) */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem; }
        .card {
            background: white; border-radius: var(--radius-xl); padding: 1.5rem;
            border: 1px solid var(--border); box-shadow: var(--shadow-card);
            transition: 0.2s; cursor: pointer; display: flex; flex-direction: column;
            height: 100%;
        }
        .card:hover { transform: translateY(-5px); box-shadow: var(--shadow-soft); }
        .card-header { display: flex; justify-content: space-between; margin-bottom: 1rem; }
        .card h3 { font-size: 1.1rem; font-weight: 700; margin-bottom: 0.5rem; color: var(--text-dark); display:flex; align-items:center; gap:5px; }
        .card p { color: var(--text-muted); font-size: 0.9rem; line-height: 1.5; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
        .badge { padding: 5px 12px; border-radius: 20px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; }

        /* CONTACTS GRID */
        .contact-card {
            background: white; border-radius: var(--radius-md); padding: 1.2rem;
            border: 1px solid var(--border); box-shadow: var(--shadow-card);
            display: flex; align-items: center; gap: 1rem; transition: 0.2s;
            position: relative;
        }
        .contact-card:hover { border-color: var(--primary); transform: translateY(-2px); }
        .contact-avatar {
            width: 50px; height: 50px; background: var(--secondary-light); color: var(--secondary);
            border-radius: 15px; display: flex; align-items: center; justify-content: center;
            font-weight: 700; font-size: 1.2rem; position: relative;
        }

        /* MODALS */
        .modal-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(45, 52, 54, 0.4); backdrop-filter: blur(8px);
            z-index: 1000; display: none; align-items: center; justify-content: center;
            opacity: 0; transition: opacity 0.3s;
        }
        .modal-backdrop.active { display: flex; opacity: 1; }
        .modal-panel {
            background: white; width: 90%; max-width: 900px;
            border-radius: 30px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            display: flex; flex-direction: column; overflow: hidden;
            transform: scale(0.95); transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            max-height: 90vh;
        }
        .modal-backdrop.active .modal-panel { transform: scale(1); }
        .modal-header { padding: 1.5rem 2rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: #fafbfc; flex-shrink: 0; }
        .modal-body { padding: 2.5rem; overflow-y: auto; }

        .editor-meta-bar {
            padding: 10px 20px; background: #f8fafc; border-bottom: 1px solid var(--border);
            display: flex; gap: 15px; flex-wrap: wrap; align-items: center;
        }

        /* WIZARD STYLES */
        .wizard-container { display: flex; height: 60vh; }
        .wizard-sidebar { width: 30%; background: #f8fafc; padding: 2rem; border-right: 1px solid var(--border); display: flex; flex-direction: column; }
        .wizard-content { width: 70%; padding: 2rem; overflow-y: auto; }
        
        .wizard-step-indicator { display: flex; gap: 10px; margin-bottom: 2rem; }
        .ws-dot { width: 10px; height: 10px; border-radius: 50%; background: #e2e8f0; }
        .ws-dot.active { background: var(--primary); }
        .ws-dot.done { background: var(--secondary); }

        .tutorial-box {
            background: #fff; border: 1px solid #e2e8f0; border-radius: 16px; padding: 1.5rem;
            margin-top: auto; box-shadow: 0 4px 6px rgba(0,0,0,0.02);
        }
        .tuto-icon { font-size: 1.5rem; margin-bottom: 10px; display: block; }
        .tuto-title { font-weight: 700; margin-bottom: 5px; color: var(--text-dark); }
        .tuto-text { font-size: 0.85rem; color: var(--text-muted); line-height: 1.5; }

        /* SUBMISSION CARD */
        .submission-card {
            background: white; border: 1px solid var(--border); border-radius: 12px; padding: 1rem;
            margin-bottom: 1rem; display: flex; gap: 15px; align-items: center;
        }
        .sub-type-badge {
            padding: 4px 10px; border-radius: 6px; font-size: 0.7rem; font-weight: 800; text-transform: uppercase;
        }
        .sub-type-article { background: var(--primary-light); color: var(--primary); }
        .sub-type-contact { background: var(--secondary-light); color: var(--secondary); }
        .sub-type-feedback { background: #fee2e2; color: #ef4444; }

        /* SETTINGS LIST STYLE */
        .cat-group {
            background: white; border: 1px solid var(--border); border-radius: 12px; 
            margin-bottom: 10px; overflow: hidden;
        }
        .cat-row {
            display: flex; align-items: center; gap: 10px; padding: 12px 15px;
            background: #f8fafc; transition: 0.2s;
        }
        .cat-row input[type="text"] { flex: 1; border: none; background: transparent; font-weight: 700; color: var(--text-dark); font-size: 1rem; }
        
        .subcat-container { padding: 10px 15px 15px 45px; background: white; border-top: 1px solid var(--border); display: none; }
        .subcat-container.open { display: block; }
        .subcat-row {
            display: flex; align-items: center; gap: 10px; margin-bottom: 8px;
        }
        .subcat-row input { flex:1; font-size: 0.9rem; padding: 6px; border:1px solid #eee; border-radius: 8px; }
        
        .db-action-row {
            display: flex; gap: 10px; margin-bottom: 10px;
        }
        .db-action-btn {
            flex: 1; padding: 10px; border-radius: 10px; border: 1px solid var(--border);
            background: white; font-size: 0.85rem; font-weight: 600; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 5px;
        }
        .db-action-btn:hover { background: #f8fafc; border-color: var(--secondary); color: var(--secondary); }

        /* FORM ELEMENTS */
        .input-std {
            width: 100%; padding: 12px 16px; border: 1px solid #dfe6e9; border-radius: 12px;
            font-size: 0.95rem; font-family: inherit; background: #fdfdfd; transition: 0.2s;
        }
        .input-std:focus { border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-light); background: white; }

        /* TOGGLE SWITCH */
        .toggle-switch { position: relative; width: 44px; height: 24px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #cbd5e1; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(20px); }

        /* EDITOR UI */
        .block-wrapper { 
            border: 1px solid #eee; border-radius: 12px; padding: 1rem; 
            margin-bottom: 1rem; background: #fcfcfc; position: relative;
            transition: box-shadow 0.2s;
        }
        .block-wrapper.dragging { opacity: 0.5; border-color: var(--primary); }
        .block-wrapper:hover { box-shadow: 0 4px 10px rgba(0,0,0,0.05); }

        .block-handle {
            position: absolute; top: 10px; right: 10px; cursor: grab;
            color: #d1d5db; padding: 5px;
        }
        .block-handle:hover { color: var(--text-dark); }
        
        .block-toolbar { border: 2px dashed #dcdde1; color: #b2bec3; padding: 1rem; border-radius: 12px; text-align: center; cursor: pointer; transition: 0.2s; }
        .block-toolbar:hover { border-color: var(--primary); color: var(--primary); background: var(--primary-light); }
        
        /* Auto-Numbering for Steps in Editor */
        #editorBlocks { counter-reset: step-counter; }
        .block-wrapper[data-type="step"] { 
            counter-increment: step-counter; 
            border-left: 4px solid var(--secondary); 
        }
        .block-wrapper[data-type="step"] .block-type-label::after {
            content: " " counter(step-counter);
            background: var(--secondary); color: white; border-radius: 50%;
            width: 20px; height: 20px; display: inline-flex; align-items: center; justify-content: center;
            margin-left: 10px; font-size: 0.75rem;
        }

        /* READER STYLES */
        .reader-content h1 { font-size: 2rem; color: var(--text-dark); margin-bottom: 1rem; }
        .reader-block { margin-bottom: 1.5rem; line-height: 1.7; color: #4b6584; font-size: 1.05rem; }
        .reader-alert { padding: 1.5rem; border-radius: 16px; background: #fff5f5; color: #eb3b5a; display: flex; gap: 15px; align-items: flex-start; }
        
        .step-circle { 
            min-width: 32px; height: 32px; border-radius: 50%;
            background: var(--secondary-light); color: var(--secondary);
            font-weight: 800; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 10px rgba(107, 158, 255, 0.2); font-size: 1rem;
        }

        .linked-contact-box {
            background: white; border: 1px solid var(--border); border-radius: 16px;
            padding: 1rem; margin-bottom: 1rem; display: flex; align-items: center; gap: 15px;
            box-shadow: var(--shadow-card);
        }
        .linked-contact-avatar {
            width: 40px; height: 40px; background: var(--primary-light); color: var(--primary);
            border-radius: 10px; display: flex; align-items: center; justify-content: center; font-weight: 700;
        }

        /* TREE ENGINE */
        .tree-btn {
            background: white; border: 1px solid #dfe6e9; color: var(--text-dark); padding: 1.2rem;
            border-radius: 16px; font-weight: 600; box-shadow: var(--shadow-card); transition: 0.2s;
        }
        .tree-btn:hover { border-color: var(--primary); color: var(--primary); transform: translateY(-2px); box-shadow: var(--shadow-soft); }
        
        /* MISC */
        .hidden { display: none !important; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.1",
    "react-dom/": "https://esm.sh/react-dom@^19.2.1/",
    "react/": "https://esm.sh/react@^19.2.1/",
    "lucide-react": "https://esm.sh/lucide-react@^0.559.0"
  }
}
</script>
<link rel="stylesheet" href="/index.css">
</head>
<body>

    <!-- SIDEBAR -->
    <nav class="sidebar">
        <div class="brand">
            <div class="logo-shape"></div>
            <span>MediBase</span>
        </div>

        <button class="nav-btn active" onclick="switchView('dashboard', this)">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="3" y="3" width="7" height="9" rx="2"></rect><rect x="14" y="3" width="7" height="5" rx="2"></rect><rect x="14" y="12" width="7" height="9" rx="2"></rect><rect x="3" y="16" width="7" height="5" rx="2"></rect></svg>
            Tableau de bord
        </button>

        <button class="nav-btn" onclick="switchView('directory', this)">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><line x1="20" y1="8" x2="20" y2="14"></line><line x1="23" y1="11" x2="17" y2="11"></line></svg>
            Annuaire
        </button>

        <div class="menu-label">Base de connaissances</div>
        <button class="nav-btn" onclick="switchView('grid', this); filterGrid('all', null, this)">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>
            Tout explorer
        </button>

        <div id="categoryNav"></div>
        
        <div style="margin-top:2rem; padding:0 0.5rem;">
            <button class="btn-primary" style="width:100%; justify-content:center;" onclick="openSubmissionWizard()">
                ‚ú® Contribuer
            </button>
        </div>

        <div class="admin-panel">
            <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:1.5rem; padding: 0 0.5rem;">
                <span style="color:var(--text-muted); font-size:0.8rem; font-weight:700; text-transform:uppercase; letter-spacing:0.05em;">Admin</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="adminToggle" onchange="toggleAdmin()">
                    <span class="slider"></span>
                </label>
            </div>
            
            <div id="adminMenu" class="hidden">
                 <button class="nav-btn" onclick="triggerContributionImport()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                    Importer contribution
                </button>
                <input type="file" id="contribImportInput" hidden onchange="processContributionImport(this)">
                <button class="nav-btn" onclick="openSettings()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                    Gestion & Bases
                </button>
            </div>
        </div>
    </nav>

    <!-- MAIN -->
    <main class="main-content">
        <header class="top-header">
            <div class="header-title">
                <h2 id="headerTitle">Vue d'ensemble</h2>
                <p id="headerDate">Aujourd'hui</p>
            </div>
            
            <div class="header-actions">
                <div class="search-container">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                    <input type="text" id="searchInput" class="search-input" placeholder="Rechercher..." onkeyup="handleSearch()">
                </div>
                
                <div class="profile-btn" title="Utilisateur">
                    <img src="https://ui-avatars.com/api/?name=Admin+User&background=6B9EFF&color=fff&rounded=true" alt="Profile">
                </div>
            </div>
        </header>
        
        <div style="position:absolute; top: 110px; right: 40px; z-index: 5;">
            <button id="addArticleBtn" class="btn-primary hidden" onclick="openEditor()">
                <span>+</span> Nouvelle Fiche
            </button>
            <button id="addContactBtn" class="btn-primary hidden" onclick="openContactEditor()">
                <span>+</span> Nouveau Contact
            </button>
        </div>

        <!-- DASHBOARD VIEW -->
        <div id="viewDashboard" class="view-container active-view">
            
            <div class="dash-layout">
                <!-- Main Widget Area -->
                <div class="dash-main">
                    <div class="stats-container">
                        <div class="stat-card">
                            <div class="stat-label">Base de donn√©es</div>
                            <div class="stat-value" id="statArticles">0</div>
                            <div class="stat-desc">Fiches protocolaires</div>
                        </div>
                        <div class="stat-card blue">
                            <div class="stat-label">Annuaire</div>
                            <div class="stat-value" id="statContacts">0</div>
                            <div class="stat-desc">Contacts enregistr√©s</div>
                        </div>
                        <div class="stat-card teal">
                            <div class="stat-label">Favoris</div>
                            <div class="stat-value" id="statPinned">0</div>
                            <div class="stat-desc">Widgets actifs</div>
                        </div>
                    </div>

                    <div class="section-header" style="margin-top:1rem;">
                        <span class="section-title">Acc√®s Rapide</span>
                        <span id="dashEditHint" class="hidden" style="color:var(--primary); font-size:0.8rem; font-weight:600;">Glisser-d√©poser pour organiser</span>
                    </div>
                    <div id="dashboardPinned" class="pinned-stack">
                        <!-- Widgets injected via JS -->
                    </div>
                </div>
            </div>
        </div>

        <!-- GRID VIEW (Articles) -->
        <div id="viewGrid" class="view-container">
             <div class="section-header">
                <span class="section-title">Protocoles & Fiches</span>
            </div>
            <div id="grid" class="grid"></div>
        </div>

        <!-- DIRECTORY VIEW -->
        <div id="viewDirectory" class="view-container">
            <div class="section-header">
                <span class="section-title">Annuaire du personnel</span>
            </div>
            <div id="contactGrid" class="grid" style="grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));"></div>
        </div>

    </main>

    <!-- READER MODAL -->
    <div id="readerModal" class="modal-backdrop">
        <div class="modal-panel">
            <div class="modal-header">
                <span id="readCat" class="badge" style="background:var(--secondary-light); color:var(--secondary);">Cat√©gorie</span>
                <button onclick="closeModal('readerModal')" class="btn-icon">√ó</button>
            </div>
            <div id="readContent" class="modal-body reader-content"></div>
            <div style="padding: 1.5rem 2.5rem; border-top: 1px solid var(--border); background: #fafbfc; text-align: right;">
                 <button class="btn-ghost" style="color:var(--danger); font-size:0.85rem;" onclick="reportError()">‚ö† Signaler une erreur</button>
            </div>
        </div>
    </div>
    
    <!-- SUBMISSION WIZARD MODAL -->
    <div id="submissionModal" class="modal-backdrop">
        <div class="modal-panel" style="width: 100%; height: 100%; max-width: 100%; max-height: 100%; border-radius: 0;">
            <div class="modal-header">
                <h3>Assistant de Contribution</h3>
                <button onclick="closeModal('submissionModal')" class="btn-icon">√ó</button>
            </div>
            <div class="wizard-container" style="height: auto; flex: 1;">
                <!-- Left: Guide -->
                <div class="wizard-sidebar">
                    <div id="wizardSteps" class="wizard-step-indicator">
                        <div class="ws-dot active"></div>
                        <div class="ws-dot"></div>
                        <div class="ws-dot"></div>
                    </div>
                    <div id="wizardTutorial" class="tutorial-box">
                        <span class="tuto-icon">üí°</span>
                        <div class="tuto-title">Bienvenue</div>
                        <div class="tuto-text">Votre expertise est pr√©cieuse. Cet assistant va vous guider pour cr√©er une fiche claire et utile pour toute l'√©quipe.</div>
                    </div>
                </div>
                
                <!-- Right: Form -->
                <div class="wizard-content" style="position:relative; display:flex; flex-direction:column;">
                    <div id="wizardStep1">
                        <h2 style="margin-bottom:2rem;">Que souhaitez-vous partager ?</h2>
                        <div style="display:grid; gap:1rem; grid-template-columns: 1fr 1fr;">
                            <div onclick="setSubmissionType('article')" class="widget-card" style="aspect-ratio:auto; padding:2rem; align-items:flex-start; text-align:left;">
                                <div class="widget-icon-box w-color-1">üìÑ</div>
                                <h3 style="margin-bottom:5px;">Nouvelle Fiche</h3>
                                <p style="font-size:0.9rem; color:var(--text-muted);">Cr√©er un protocole, une proc√©dure ou une note d'information.</p>
                            </div>
                            <!-- NEW TREE BUTTON -->
                            <div onclick="setSubmissionType('tree')" class="widget-card" style="aspect-ratio:auto; padding:2rem; align-items:flex-start; text-align:left;">
                                <div class="widget-icon-box" style="background:#eef5ff; color:#4b7bec;">üå≥</div>
                                <h3 style="margin-bottom:5px;">Arbre de d√©cision</h3>
                                <p style="font-size:0.9rem; color:var(--text-muted);">Cr√©er un algorithme interactif.</p>
                            </div>
                             <div onclick="setSubmissionType('contact')" class="widget-card" style="aspect-ratio:auto; padding:2rem; align-items:flex-start; text-align:left;">
                                <div class="widget-icon-box w-color-2">üë§</div>
                                <h3 style="margin-bottom:5px;">Nouveau Contact</h3>
                                <p style="font-size:0.9rem; color:var(--text-muted);">Ajouter un m√©decin, un service ou un num√©ro utile.</p>
                            </div>
                             <div onclick="setSubmissionType('feedback')" class="widget-card" style="aspect-ratio:auto; padding:2rem; align-items:flex-start; text-align:left; border-color:var(--danger);">
                                <div class="widget-icon-box" style="background:#fee2e2; color:var(--danger);">‚ö†</div>
                                <h3 style="margin-bottom:5px;">Signalement</h3>
                                <p style="font-size:0.9rem; color:var(--text-muted);">Signaler une erreur ou une donn√©e obsol√®te.</p>
                            </div>
                        </div>
                    </div>

                    <div id="wizardStep2" class="hidden" style="flex:1; overflow-y:auto; position:relative;">
                        <!-- Dynamic Form Content -->
                    </div>

                    <div style="margin-top:auto; padding-top:2rem; display:flex; justify-content:space-between; border-top:1px solid #eee;">
                        <button id="wizardBackBtn" class="btn-ghost hidden" onclick="wizardBack()">‚Üê Retour</button>
                        <button id="wizardNextBtn" class="btn-primary hidden" onclick="wizardNext()">Suivant ‚Üí</button>
                        <button id="wizardSubmitBtn" class="btn-primary hidden" onclick="submitRequest()">üì• T√©l√©charger & Envoyer</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- FEEDBACK VIEW MODAL -->
    <div id="feedbackViewModal" class="modal-backdrop">
         <div class="modal-panel" style="max-width: 500px;">
            <div class="modal-header">
                <h3>Signalement d'Erreur</h3>
                <button onclick="closeModal('feedbackViewModal')" class="btn-icon">√ó</button>
            </div>
            <div class="modal-body">
                <div style="background:#fee2e2; color:#991b1b; padding:10px; border-radius:8px; margin-bottom:1rem; font-size:0.9rem;">
                    <strong>Concerne : </strong> <span id="fbRefTitle"></span>
                </div>
                <div style="margin-bottom:2rem;">
                    <label style="display:block; margin-bottom:5px; font-weight:600; color:#666;">Message du contributeur</label>
                    <div id="fbMessage" style="background:#f8fafc; padding:15px; border-radius:12px; line-height:1.5;"></div>
                </div>
                <div style="text-align:right;">
                    <button class="btn-primary" onclick="closeModal('feedbackViewModal')">J'ai compris</button>
                </div>
            </div>
         </div>
    </div>

    <!-- ARTICLE EDITOR MODAL (ADMIN) -->
    <div id="editorModal" class="modal-backdrop">
        <div id="editorPanel" class="modal-panel" style="height: 90vh;">
            <div class="modal-header">
                <div style="flex:1; margin-right:20px;">
                    <input type="text" id="editTitle" class="input-std" placeholder="Titre de la fiche" style="font-size:1.5rem; font-weight:700; border:none; padding:0; background:transparent;">
                </div>
                <div style="display:flex; gap:10px;">
                    <button onclick="closeModal('editorModal')" class="btn-ghost">Annuler</button>
                    <button onclick="saveArticle()" class="btn-primary">Enregistrer</button>
                </div>
            </div>
            
            <div class="editor-meta-bar">
                <select id="editCat" class="input-std" style="padding:6px 12px; width:auto;" onchange="updateSubCatSelect()"></select>
                <select id="editSubCat" class="input-std" style="padding:6px 12px; width:auto; display:none;"></select>
                <select id="editScope" class="input-std" style="padding:6px 12px; width:auto; background:#f0f2f5; font-weight:600;">
                    <option value="local">Local (Agence)</option>
                    <option value="regional">R√©gional</option>
                    <option value="global">Global (Si√®ge)</option>
                </select>
                <div style="margin-left:auto; display:flex; gap:5px;">
                     <button class="btn-secondary" id="typeStandard" onclick="setEditorType('standard')">Standard</button>
                     <button class="btn-secondary" id="typeTree" onclick="setEditorType('tree')">Arbre</button>
                </div>
            </div>

            <div class="modal-body" style="background:#f9f9f9; padding:0; display:flex; flex-direction:column; flex:1; overflow:hidden;">
                <!-- STANDARD EDITOR -->
                <div id="editorStandard" class="editor-section" style="padding:2rem; overflow-y:auto;">
                    <div id="editorBlocks"></div>
                    <div class="block-toolbar" onclick="addBlock('text')">+ Ajouter un bloc texte</div>
                    <div style="display:flex; gap:10px; margin-top:10px; justify-content:center;">
                        <button onclick="addBlock('step')" class="btn-secondary">+ √âtape</button>
                        <button onclick="addBlock('alert', 'warning')" class="btn-secondary" style="color:#e67e22;">! Alerte</button>
                        <button onclick="addBlock('image')" class="btn-secondary">üì∑ Image</button>
                        <button onclick="addBlock('link')" class="btn-secondary">üîó Lien</button>
                        <button onclick="addBlock('contact')" class="btn-secondary">üë§ Contact</button>
                    </div>
                </div>

                <!-- TREE VISUAL EDITOR (ADMIN) -->
                <div id="editorTree" class="editor-section hidden" style="position:relative; width:100%; height:100%;">
                    <div id="treeCanvas" class="tree-canvas-container" style="width:100%; height:100%; position:absolute; background-image: radial-gradient(#d1d5db 1px, transparent 1px); background-size: 20px 20px; background-color:#f8fafc;" onmousedown="startCanvasDrag(event)" onwheel="handleZoom(event)">
                        <div class="canvas-transform-layer" id="canvasLayer" style="transform-origin:0 0;">
                            <svg id="connectionsLayer" class="connections" style="position:absolute;top:0;left:0;pointer-events:none;width:100%;height:100%;overflow:visible;"></svg>
                            <div id="nodesLayer"></div>
                        </div>
                    </div>
                    <div style="position:absolute; bottom:20px; left:20px;">
                        <button onclick="addVisualNode()" class="btn-primary">+ Question</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- SHARED NODE PROPS PANEL (Used by both Admin and Wizard) -->
     <div id="nodePropsPanel" class="node-properties-panel" style="display:none; position:fixed; z-index:1100; right:20px; top:20px; width:300px; background:white; padding:1.5rem; border-radius:16px; box-shadow:var(--shadow-card);">
        <div style="display:flex; justify-content:space-between; margin-bottom:1rem; align-items:center;">
            <h4>√âditer le noeud</h4>
            <button onclick="closeNodeProps()" class="btn-icon">√ó</button>
        </div>
        <input type="hidden" id="propNodeId">
        <textarea id="propNodeText" rows="3" class="input-std" placeholder="Question..." style="margin-bottom:10px" onkeyup="saveProps()"></textarea>
        <div id="propChoicesList"></div>
        <button onclick="addPropChoice()" class="btn-secondary" style="width:100%; margin-top:5px;">+ Ajouter r√©ponse</button>
        <button onclick="deleteVisualNode()" class="btn-secondary" style="width:100%; margin-top:1rem; background:#fee2e2; color:#ef4444;">Supprimer noeud</button>
    </div>

    <!-- CONTACT EDITOR MODAL -->
    <div id="contactModal" class="modal-backdrop">
        <div class="modal-panel" style="max-width: 500px;">
            <div class="modal-header">
                <h3>Contact</h3>
                <button onclick="closeModal('contactModal')" class="btn-icon">√ó</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="contactId">
                <input type="text" id="contactName" class="input-std" placeholder="Nom Pr√©nom" style="margin-bottom:1rem; font-weight:700;">
                <div style="display:flex; gap:10px; margin-bottom:1rem; align-items:center;">
                    <select id="contactCat" class="input-std" style="flex:1;"></select>
                    <select id="contactScope" class="input-std" style="flex:1; font-weight:600;">
                        <option value="local">Local</option>
                        <option value="regional">R√©gional</option>
                        <option value="global">Global</option>
                    </select>
                </div>
                <div style="text-align:right; margin-bottom:1rem;">
                    <button onclick="openSettings(); closeModal('contactModal');" style="white-space:nowrap; border:none; background:none; color:var(--primary); font-weight:600; cursor:pointer; font-size:0.8rem;">G√©rer les cat√©gories</button>
                </div>
                <div id="contactFields"></div>
                <button onclick="addContactField()" style="color:var(--primary); background:none; border:none; cursor:pointer; font-weight:600; font-size:0.9rem;">+ Ajouter un champ</button>
                <div style="margin-top:2rem; display:flex; justify-content:space-between;">
                    <button id="btnDeleteContact" onclick="deleteContact()" class="btn-icon danger">üóë</button>
                    <div style="display:flex; gap:10px;">
                        <button onclick="closeModal('contactModal')" class="btn-ghost">Annuler</button>
                        <button onclick="saveContact()" class="btn-primary">Enregistrer</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- WIDGET MODAL -->
    <div id="widgetModal" class="modal-backdrop">
        <div class="modal-panel" style="max-width: 500px;">
            <div class="modal-header">
                <h3>Ajouter au Dashboard</h3>
                <button onclick="closeModal('widgetModal')" class="btn-icon">√ó</button>
            </div>
            <div class="modal-body">
                <label style="display:block; margin-bottom:10px; font-weight:600;">Type</label>
                <select id="widgetType" class="input-std" onchange="toggleWidgetFields()" style="margin-bottom:15px;">
                    <option value="article">Fiche / Protocole</option>
                    <option value="contact">Contact</option>
                    <option value="link">Lien Web</option>
                </select>

                <div id="fieldWidgetArticle">
                    <select id="widgetArticleSelect" class="input-std"></select>
                </div>

                <div id="fieldWidgetContact" class="hidden">
                    <select id="widgetContactSelect" class="input-std"></select>
                </div>

                <div id="fieldWidgetLink" class="hidden">
                    <input type="text" id="widgetLinkTitle" class="input-std" placeholder="Titre" style="margin-bottom:10px;">
                    <input type="text" id="widgetLinkUrl" class="input-std" placeholder="URL">
                </div>

                <div style="margin-top:20px; text-align:right; display:flex; justify-content:flex-end; gap:10px;">
                    <button onclick="closeModal('widgetModal')" class="btn-ghost">Annuler</button>
                    <button onclick="saveWidget()" class="btn-primary">Ajouter</button>
                </div>
            </div>
        </div>
    </div>

    <!-- SETTINGS MODAL -->
    <div id="settingsModal" class="modal-backdrop">
        <div class="modal-panel" style="max-width: 600px;">
            <div class="modal-header">
                <h3>Gestion & Bases</h3>
                <button onclick="closeModal('settingsModal')" class="btn-icon">√ó</button>
            </div>
            <div class="modal-body">
                <!-- EXPORT SECTION -->
                <h4 style="margin-bottom:0.5rem; color:var(--text-muted); text-transform:uppercase; font-size:0.75rem;">Exports (Sauvegarde)</h4>
                <div class="db-action-row">
                    <button class="db-action-btn" onclick="exportDatabase('global')"><span style="color:var(--scope-global)">‚óè</span> Base Globale</button>
                    <button class="db-action-btn" onclick="exportDatabase('regional')"><span style="color:var(--scope-regional)">‚óè</span> Base R√©gionale</button>
                    <button class="db-action-btn" onclick="exportDatabase('local')"><span style="color:var(--scope-local)">‚óè</span> Base Locale</button>
                </div>
                <button class="btn-primary" onclick="exportDatabase('all')" style="width:100%; margin-bottom:2rem;">üíæ Sauvegarde Compl√®te (Tout)</button>

                <!-- IMPORT SECTION -->
                <h4 style="margin-bottom:0.5rem; color:var(--text-muted); text-transform:uppercase; font-size:0.75rem;">Imports (Mise √† jour)</h4>
                <div style="margin-bottom:2rem; padding:15px; background:#f0f2f5; border-radius:12px;">
                    <p style="font-size:0.85rem; margin-bottom:10px; color:var(--text-muted);">S√©lectionnez un fichier JSON. L'import remplacera uniquement les donn√©es de la port√©e choisie.</p>
                    <div class="db-action-row">
                        <button class="db-action-btn" onclick="triggerImport('global')">üì• Import Global</button>
                        <button class="db-action-btn" onclick="triggerImport('regional')">üì• Import R√©gional</button>
                        <button class="db-action-btn" onclick="triggerImport('local')">üì• Import Local</button>
                        <button class="db-action-btn" onclick="triggerImport('all')" style="color:var(--text-dark)">‚ö†Ô∏è Restauration Totale</button>
                    </div>
                </div>
                <input type="file" id="dbFileInput" hidden onchange="processImport(this)">

                <hr style="border:0; border-top:1px solid var(--border); margin:1.5rem 0;">

                <h4 style="margin-bottom:1rem; color:var(--text-muted);">Cat√©gories Fiches & Sous-cat√©gories</h4>
                <div id="catListEdit"></div>
                <div style="display:flex; gap:10px; margin-bottom:2rem; margin-top:1rem; padding:10px; background:#f0f2f5; border-radius:12px; align-items:center;">
                    <input type="color" id="newCatColor" value="#FF8F6B" style="width:40px; height:40px; border:none; background:none; cursor:pointer;">
                    <input type="text" id="newCatName" class="input-std" placeholder="Nouvelle cat√©gorie..." style="background:white;">
                    <button onclick="addCategory('article')" class="btn-icon" style="background:var(--primary); color:white;">+</button>
                </div>

                <h4 style="margin-bottom:1rem; color:var(--text-muted);">Cat√©gories Annuaire</h4>
                <div id="contactCatListEdit"></div>
                <div style="display:flex; gap:10px; margin-top:1rem; padding:10px; background:#f0f2f5; border-radius:12px; align-items:center;">
                    <input type="text" id="newContactCatName" class="input-std" placeholder="Nouvelle cat√©gorie..." style="background:white;">
                    <button onclick="addCategory('contact')" class="btn-icon" style="background:var(--primary); color:white;">+</button>
                </div>
                
                <div style="text-align:right; margin-top:2rem;">
                     <button onclick="closeModal('settingsModal')" class="btn-ghost">Fermer</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- DONN√âES PAR D√âFAUT ---
        const defaultData = {
            categories: [
                { id: 'c1', name: 'M√©dical', color: '#FF8F6B', subcategories: [{id:'sc1', name:'Cardiologie'}], scope: 'global' },
                { id: 'c2', name: 'Administratif', color: '#6B9EFF', subcategories: [], scope: 'global' },
                { id: 'c3', name: 'Technique', color: '#4ECDC4', subcategories: [], scope: 'local' }
            ],
            contactCategories: [
                { id: 'cc1', name: 'Garde' }, { id: 'cc2', name: 'Direction' }
            ],
            articles: [
                {
                    id: 'a1', title: 'Protocole d\'accueil', catId: 'c2', type: 'standard', scope: 'global',
                    blocks: [{ type: 'alert', variant: 'info', content: 'V√©rifier l\'identit√© du patient.' }]
                }
            ],
            contacts: [
                {
                    id: 'ct1', name: 'Dr. House', catId: 'cc1', scope: 'global',
                    fields: [{ label: 'Bip', value: '4002' }]
                }
            ],
            dashboardWidgets: [
                { id: 'w1', type: 'article', contentId: 'a1', scope: 'local' },
                { id: 'w2', type: 'link', title: 'Planning Garde', url: '#', scope: 'local' }
            ],
            dashboardInfo: {
                title: "Information",
                content: "Pensez √† mettre √† jour les protocoles d'urgence avant la fin du mois.",
                tag: "Priorit√© Haute"
            }
        };

        // --- STATE ---
        let appData = { categories: [], contactCategories:[], articles: [], contacts: [], dashboardWidgets: [], dashboardInfo: {} };
        let isAdmin = false;
        let currentView = 'dashboard';
        let filterCatId = 'all';
        let filterSubCatId = null;
        let currentEditId = null;
        let editorMode = 'standard';
        let pendingImportScope = null;
        let currentReadArticle = null;
        
        // Wizard State
        let subType = null;
        let subStep = 1;
        let subData = {};
        let subTreeNodes = []; // New state for Wizard Tree

        // Drag/Canvas State
        let dragSrcEl = null;
        let treeNodes = [], draggedNode = null, dragOffset = { x: 0, y: 0 };
        let canvasScale = 1, canvasTranslate = { x: 0, y: 0 }, isPanning = false, startPan = { x:0, y:0 };
        let blockDragSrc = null;
        
        // Tree Editing Context (Admin vs Wizard)
        let editingContext = 'admin';

        // --- INIT ---
        function init() {
            // Set date
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('headerDate').innerText = new Date().toLocaleDateString('fr-FR', options);

            const stored = localStorage.getItem('medibase_db');
            if(stored) {
                appData = JSON.parse(stored);
                if(!appData.dashboardWidgets) appData.dashboardWidgets = [];
                if(!appData.dashboardInfo) appData.dashboardInfo = defaultData.dashboardInfo;
                
                appData.categories.forEach(c => { if(!c.subcategories) c.subcategories = []; });
                // Data migration for scopes
                appData.articles.forEach(a => { if(!a.scope) a.scope = 'local'; });
                appData.contacts.forEach(c => { if(!c.scope) c.scope = 'local'; });
                appData.categories.forEach(c => { if(!c.scope) c.scope = 'local'; });
            } else {
                appData = JSON.parse(JSON.stringify(defaultData));
            }
            renderSidebar();
            renderDashboard();
        }

        function saveData() {
            localStorage.setItem('medibase_db', JSON.stringify(appData));
            if(currentView === 'dashboard') renderDashboard();
            if(currentView === 'grid') renderGrid();
            if(currentView === 'directory') renderDirectory();
            renderSidebar();
        }

        // --- NAVIGATION ---
        function switchView(viewName, btn) {
            currentView = viewName;
            document.querySelectorAll('.view-container').forEach(el => el.classList.remove('active-view'));
            document.getElementById('view' + viewName.charAt(0).toUpperCase() + viewName.slice(1)).classList.add('active-view');
            
            if(btn) {
                document.querySelectorAll('.sidebar .nav-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            }
            
            const titles = { dashboard: 'Vue d\'ensemble', grid: 'Base de connaissances', directory: 'Annuaire' };
            document.getElementById('headerTitle').innerText = titles[viewName];

            toggleAdmin();

            if(viewName === 'dashboard') renderDashboard();
            if(viewName === 'grid') renderGrid();
            if(viewName === 'directory') renderDirectory();
        }

        function handleSearch() {
            if(currentView === 'directory') renderDirectory();
            else if(currentView === 'grid') renderGrid();
        }

        function toggleAdmin() {
            isAdmin = document.getElementById('adminToggle').checked;
            document.body.classList.toggle('admin-mode', isAdmin);
            document.getElementById('adminMenu').classList.toggle('hidden', !isAdmin);
            
            document.getElementById('addArticleBtn').classList.toggle('hidden', !(isAdmin && currentView !== 'directory'));
            document.getElementById('addContactBtn').classList.toggle('hidden', !(isAdmin && currentView === 'directory'));
            document.getElementById('dashEditHint').classList.toggle('hidden', !(isAdmin && currentView === 'dashboard'));
            
            if(currentView === 'dashboard') renderDashboard();
            if(currentView === 'grid') renderGrid();
            if(currentView === 'directory') renderDirectory();
        }
        
        // --- SUBMISSION WIZARD ---
        function openSubmissionWizard(prefillType = null, refData = null) {
            subData = {};
            if(prefillType) {
                setSubmissionType(prefillType, refData);
            } else {
                // Reset to Step 1
                document.getElementById('wizardStep1').classList.remove('hidden');
                document.getElementById('wizardStep2').classList.add('hidden');
                document.getElementById('wizardBackBtn').classList.add('hidden');
                document.getElementById('wizardNextBtn').classList.add('hidden');
                document.getElementById('wizardSubmitBtn').classList.add('hidden');
                updateWizardSteps(1);
                updateWizardTutorial('welcome');
            }
            openModal('submissionModal');
        }

        function setSubmissionType(type, refData = null) {
            subType = type;
            document.getElementById('wizardStep1').classList.add('hidden');
            document.getElementById('wizardStep2').classList.remove('hidden');
            document.getElementById('wizardBackBtn').classList.remove('hidden');
            
            const container = document.getElementById('wizardStep2');
            container.innerHTML = '';
            
            // Default Context for editing nodes inside wizard
            editingContext = (type === 'tree') ? 'wizard' : 'admin';

            const scopeSelector = `
                <label style="display:block;margin-bottom:5px;font-weight:600;margin-top:1rem;">Port√©e de cette contribution</label>
                <select id="subScope" class="input-std" style="margin-bottom:1rem;background:#f0f2f5;">
                    <option value="local">Local (Agence/Site)</option>
                    <option value="regional">R√©gional</option>
                    <option value="global">Global (National)</option>
                </select>
            `;

            if(type === 'article') {
                updateWizardTutorial('article');
                container.innerHTML = `
                    <label style="display:block;margin-bottom:5px;font-weight:600;">Titre de la fiche</label>
                    <input type="text" id="subTitle" class="input-std" placeholder="Ex: Protocole AVC" style="margin-bottom:1rem;">
                    <label style="display:block;margin-bottom:5px;font-weight:600;">Cat√©gorie</label>
                    <select id="subCat" class="input-std" style="margin-bottom:1rem;">
                        ${appData.categories.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}
                    </select>
                    <label style="display:block;margin-bottom:5px;font-weight:600;">Contenu</label>
                    <div id="subBlocksContainer">
                         <div class="block-wrapper" data-type="text"><textarea class="input-std block-input" rows="4" placeholder="√âcrivez le contenu ici..."></textarea></div>
                    </div>
                    <button onclick="addSubmissionBlock('text')" class="btn-secondary">+ Texte</button>
                    <button onclick="addSubmissionBlock('step')" class="btn-secondary">+ √âtape</button>
                    <button onclick="addSubmissionBlock('alert')" class="btn-secondary" style="color:#e67e22;">! Alerte</button>
                    ${scopeSelector}
                `;
                document.getElementById('wizardSubmitBtn').classList.remove('hidden');
            } else if (type === 'tree') {
                updateWizardTutorial('tree');
                // TREE EDITOR FOR WIZARD
                container.innerHTML = `
                     <label style="display:block;margin-bottom:5px;font-weight:600;">Titre de l'arbre</label>
                     <input type="text" id="subTitle" class="input-std" placeholder="Ex: Algorithme Dyspn√©e" style="margin-bottom:1rem;">
                     <label style="display:block;margin-bottom:5px;font-weight:600;">Cat√©gorie</label>
                     <select id="subCat" class="input-std" style="margin-bottom:1rem;">
                        ${appData.categories.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}
                     </select>
                     <div style="flex:1; border:1px solid #ddd; border-radius:12px; height:400px; position:relative; overflow:hidden;">
                         <div id="subTreeCanvas" class="tree-canvas-container" style="width:100%; height:100%; position:absolute; background-image: radial-gradient(#d1d5db 1px, transparent 1px); background-size: 20px 20px; background-color:#f8fafc;" onmousedown="startWizardCanvasDrag(event)" onwheel="handleWizardZoom(event)">
                            <div class="canvas-transform-layer" id="subCanvasLayer" style="transform-origin:0 0;">
                                <svg id="subConnectionsLayer" class="connections" style="position:absolute;top:0;left:0;pointer-events:none;width:100%;height:100%;overflow:visible;"></svg>
                                <div id="subNodesLayer"></div>
                            </div>
                        </div>
                        <div style="position:absolute; bottom:20px; left:20px;">
                            <button onclick="addWizardNode()" class="btn-primary">+ Question</button>
                        </div>
                     </div>
                     ${scopeSelector}
                `;
                document.getElementById('wizardSubmitBtn').classList.remove('hidden');
                setTimeout(() => {
                    subTreeNodes = [{id:'start', x:50, y:50, text:'D√©but', choices:[]}];
                    renderWizardTree();
                }, 100);
            } else if (type === 'contact') {
                updateWizardTutorial('contact');
                container.innerHTML = `
                    <label style="display:block;margin-bottom:5px;font-weight:600;">Nom du contact</label>
                    <input type="text" id="subName" class="input-std" placeholder="Nom Pr√©nom ou Service" style="margin-bottom:1rem;">
                    
                    <label style="display:block;margin-bottom:5px;font-weight:600;">Cat√©gorie</label>
                    <select id="subContactCat" class="input-std" style="margin-bottom:1rem;">
                        ${appData.contactCategories.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}
                    </select>
                    
                    <div id="subContactFields">
                        <div style="display:flex; gap:10px; margin-bottom:10px;">
                            <input class="input-std f-lbl" value="Tel" placeholder="Label">
                            <input class="input-std f-val" placeholder="Num√©ro">
                        </div>
                    </div>
                    <button onclick="addSubContactField()" class="btn-secondary">+ Ajouter un champ</button>
                    ${scopeSelector}
                `;
                document.getElementById('wizardSubmitBtn').classList.remove('hidden');
            } else if (type === 'feedback') {
                updateWizardTutorial('feedback');
                container.innerHTML = `
                    <label style="display:block;margin-bottom:5px;font-weight:600;">Concerne</label>
                    <div style="background:#f1f2f6; padding:10px; border-radius:8px; margin-bottom:1rem; font-weight:700;">
                        ${refData ? `Fiche : ${refData.title}` : 'Erreur g√©n√©rale / Autre'}
                        <input type="hidden" id="subRefId" value="${refData ? refData.id : ''}">
                        <input type="hidden" id="subRefTitle" value="${refData ? refData.title : 'General'}">
                    </div>
                    
                    <label style="display:block;margin-bottom:5px;font-weight:600;">Description du probl√®me</label>
                    <textarea id="subMessage" class="input-std" rows="6" placeholder="D√©crivez l'erreur ou la correction √† apporter..."></textarea>
                    <!-- No scope needed for feedback, it's just info -->
                    <input type="hidden" id="subScope" value="local">
                `;
                document.getElementById('wizardSubmitBtn').classList.remove('hidden');
            }
            updateWizardSteps(2);
        }

        function wizardBack() {
            setSubmissionType(null); // Reset
            openSubmissionWizard(); 
        }

        function addSubmissionBlock(type) {
            const div = document.createElement('div');
            div.className = 'block-wrapper'; div.dataset.type = type;
            let inner = '';
            if(type === 'text') inner = `<textarea class="input-std block-input" rows="3" placeholder="Paragraphe..."></textarea>`;
            if(type === 'step') inner = `<textarea class="input-std block-input" rows="2" placeholder="Action √† r√©aliser..."></textarea>`;
            if(type === 'alert') inner = `<textarea class="input-std block-input" rows="2" placeholder="Message important..."></textarea>`;
            div.innerHTML = `<div class="block-type-label" style="font-size:0.7rem;font-weight:700;margin-bottom:5px;">${type.toUpperCase()} <span style="float:right;cursor:pointer;color:red;" onclick="this.parentElement.parentElement.remove()">√ó</span></div>${inner}`;
            document.getElementById('subBlocksContainer').appendChild(div);
        }
        
        function addSubContactField() {
            const div = document.createElement('div');
            div.style.cssText = "display:flex; gap:10px; margin-bottom:10px;";
            div.innerHTML = `<input class="input-std f-lbl" placeholder="Label"><input class="input-std f-val" placeholder="Valeur"><button class="btn-icon danger" onclick="this.parentElement.remove()">√ó</button>`;
            document.getElementById('subContactFields').appendChild(div);
        }

        function updateWizardSteps(step) {
            const dots = document.querySelectorAll('.ws-dot');
            dots.forEach((d, i) => {
                d.classList.remove('active', 'done');
                if(i < step - 1) d.classList.add('done');
                if(i === step - 1) d.classList.add('active');
            });
        }

        function updateWizardTutorial(context) {
            const icon = document.querySelector('.tuto-icon');
            const title = document.querySelector('.tuto-title');
            const text = document.querySelector('.tuto-text');

            if(context === 'welcome') {
                icon.innerText = 'üí°'; title.innerText = 'Bienvenue'; text.innerText = "Votre expertise est pr√©cieuse. Cet assistant va vous guider pour cr√©er une fiche claire et utile pour toute l'√©quipe.";
            } else if (context === 'article') {
                icon.innerText = 'üìÑ'; title.innerText = 'Cr√©ation de Fiche'; text.innerText = "Utilisez un titre court avec un verbe d'action (ex: 'Traiter une br√ªlure'). D√©coupez votre texte en blocs simples.";
            } else if (context === 'contact') {
                icon.innerText = 'üë§'; title.innerText = 'Nouveau Contact'; text.innerText = "V√©rifiez bien les num√©ros. Si c'est un num√©ro interne, pr√©cisez 'Bip' ou 'Poste'.";
            } else if (context === 'feedback') {
                icon.innerText = 'üîß'; title.innerText = 'Correction'; text.innerText = "Soyez pr√©cis. Si vous proposez une nouvelle version d'un paragraphe, √©crivez-la en entier.";
            } else if (context === 'tree') {
                icon.innerText = 'üå≥'; title.innerText = 'Arbre de D√©cision'; text.innerText = "Cr√©ez des √©tapes logiques. Double-cliquez sur un noeud pour modifier ses questions et ses r√©ponses (liaisons).";
            }
        }

        // --- SUBMISSION LOGIC (OFFLINE JSON GENERATION) ---
        function submitRequest() {
            const scope = document.getElementById('subScope').value;
            const submission = {
                id: 'sub' + Date.now(),
                date: new Date().toISOString(),
                type: subType,
                scope: scope,
                author: "Utilisateur", // Could be dynamic if login existed
            };

            if(subType === 'article') {
                submission.data = {
                    title: document.getElementById('subTitle').value,
                    catId: document.getElementById('subCat').value,
                    blocks: Array.from(document.querySelectorAll('#subBlocksContainer .block-wrapper')).map(el => ({
                        type: el.dataset.type,
                        content: el.querySelector('.block-input').value
                    })).filter(b => b.content)
                };
                if(!submission.data.title) return alert("Titre requis");
            } else if (subType === 'tree') {
                submission.data = {
                    title: document.getElementById('subTitle').value,
                    catId: document.getElementById('subCat').value,
                    type: 'tree',
                    nodes: subTreeNodes
                };
                if(!submission.data.title) return alert("Titre requis");
            } else if (subType === 'contact') {
                submission.data = {
                    name: document.getElementById('subName').value,
                    catId: document.getElementById('subContactCat').value,
                    fields: Array.from(document.querySelectorAll('#subContactFields > div')).map(d=>({label:d.querySelector('.f-lbl').value, value:d.querySelector('.f-val').value}))
                };
                if(!submission.data.name) return alert("Nom requis");
            } else if (subType === 'feedback') {
                submission.data = {
                    refId: document.getElementById('subRefId').value,
                    refTitle: document.getElementById('subRefTitle').value,
                    message: document.getElementById('subMessage').value
                };
                 if(!submission.data.message) return alert("Message requis");
            }

            // Generate JSON File
            const fileName = `contribution_${subType}_${new Date().toISOString().split('T')[0]}.json`;
            const blob = new Blob([JSON.stringify(submission, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);

            // Trigger Email (Mailto)
            const subject = encodeURIComponent(`Contribution MediBase: ${subType.toUpperCase()} (${scope})`);
            const body = encodeURIComponent(`Bonjour,\n\nVeuillez trouver ci-joint le fichier de contribution (${fileName}) g√©n√©r√© par MediBase.\n\nCordialement.`);
            window.location.href = `mailto:?subject=${subject}&body=${body}`;

            alert("Le fichier de contribution a √©t√© t√©l√©charg√©. Veuillez l'envoyer par email √† votre administrateur (votre client mail devrait s'ouvrir).");
            closeModal('submissionModal');
        }
        
        function reportError() {
            if(currentReadArticle) {
                closeModal('readerModal');
                openSubmissionWizard('feedback', currentReadArticle);
            }
        }

        // --- ADMIN IMPORT LOGIC ---
        function triggerContributionImport() {
            document.getElementById('contribImportInput').click();
        }

        function processContributionImport(el) {
            const file = el.files[0];
            if(!file) return;

            const reader = new FileReader();
            reader.onload = e => {
                try {
                    const sub = JSON.parse(e.target.result);
                    if(!sub.type || !sub.data) throw new Error("Format invalide");

                    if(sub.type === 'article' || sub.type === 'tree') {
                        // Open Article Editor Prefilled
                        openEditor(null);
                        setTimeout(() => {
                            document.getElementById('editTitle').value = sub.data.title;
                            document.getElementById('editCat').value = sub.data.catId;
                            document.getElementById('editScope').value = sub.scope || 'local';
                            
                            if(sub.data.type === 'tree') {
                                setEditorType('tree');
                                treeNodes = sub.data.nodes || [];
                                renderVisualTree();
                            } else {
                                setEditorType('standard');
                                document.getElementById('editorBlocks').innerHTML = '';
                                if(sub.data.blocks) sub.data.blocks.forEach(b => renderBlockInput(b));
                            }
                            alert(`Contribution charg√©e (Scope: ${sub.scope}). V√©rifiez et enregistrez.`);
                        }, 100);
                    } 
                    else if(sub.type === 'contact') {
                        // Open Contact Editor Prefilled
                        openContactEditor(null);
                        setTimeout(() => {
                            document.getElementById('contactName').value = sub.data.name;
                            document.getElementById('contactCat').value = sub.data.catId;
                            document.getElementById('contactScope').value = sub.scope || 'local';
                            document.getElementById('contactFields').innerHTML = '';
                            sub.data.fields.forEach(f => addContactField(f.label, f.value));
                            alert(`Contribution contact charg√©e (Scope: ${sub.scope}).`);
                        }, 100);
                    }
                    else if(sub.type === 'feedback') {
                        // Show Feedback Modal
                        document.getElementById('fbRefTitle').innerText = sub.data.refTitle || 'Inconnu';
                        document.getElementById('fbMessage').innerText = sub.data.message;
                        openModal('feedbackViewModal');
                    }

                } catch(err) {
                    alert("Erreur: Le fichier ne semble pas √™tre une contribution MediBase valide.");
                    console.error(err);
                }
                el.value = ''; // Reset
            };
            reader.readAsText(file);
        }

        // --- DASHBOARD RENDER ---
        function renderDashboard() {
            document.getElementById('statArticles').innerText = appData.articles.length;
            document.getElementById('statContacts').innerText = appData.contacts.length;
            document.getElementById('statPinned').innerText = appData.dashboardWidgets.length;

            const container = document.getElementById('dashboardPinned');
            container.innerHTML = '';
            
            appData.dashboardWidgets.forEach((widget, index) => {
                let card = null;
                const colors = ['w-color-1', 'w-color-2', 'w-color-3'];
                const colorClass = colors[index % 3];
                const itemScope = widget.scope || 'local'; 

                if(widget.type === 'article') {
                    const item = appData.articles.find(a => a.id === widget.contentId);
                    if(item) {
                        const cat = appData.categories.find(c => c.id === item.catId);
                        card = document.createElement('div');
                        card.className = 'widget-card';
                        card.onclick = () => openReader(item);
                        card.innerHTML = `
                            <div class="widget-icon-box ${colorClass}">${item.type === 'tree' ? 'üå≥' : 'üìÑ'}</div>
                            <div class="widget-content">
                                <span class="widget-tag" style="color:${cat?.color||'#888'}">${cat?.name||'General'}</span>
                                <div class="widget-title">${item.title}</div>
                                <div style="font-size:0.7rem; color:#ccc; margin-top:2px;">${getScopeBadge(item.scope)}</div>
                            </div>
                        `;
                    }
                } else if (widget.type === 'contact') {
                    const item = appData.contacts.find(c => c.id === widget.contentId);
                    if(item) {
                        card = document.createElement('div');
                        card.className = 'widget-card';
                        card.innerHTML = `
                            <div class="widget-icon-box ${colorClass}">üë§</div>
                            <div class="widget-content">
                                <span class="widget-tag">Contact</span>
                                <div class="widget-title">${item.name}</div>
                                <div class="widget-sub">${item.fields[0]?.value || 'N/A'}</div>
                            </div>
                        `;
                    }
                } else if (widget.type === 'link') {
                    card = document.createElement('a');
                    card.href = widget.url; card.target = "_blank";
                    card.className = "widget-card link-widget";
                    card.innerHTML = `
                        <div class="widget-icon-box">üîó</div>
                        <div class="widget-content">
                            <div class="widget-title">${widget.title}</div>
                            <div class="widget-sub">Lien externe</div>
                        </div>
                    `;
                }

                if(card) {
                    if(isAdmin) {
                        const delBtn = document.createElement('div');
                        delBtn.className = 'widget-delete-btn';
                        delBtn.innerHTML = '√ó';
                        delBtn.onclick = (e) => { e.preventDefault(); e.stopPropagation(); deleteWidget(index); };
                        card.appendChild(delBtn);

                        card.draggable = true;
                        card.dataset.index = index;
                        card.addEventListener('dragstart', handleDragStart);
                        card.addEventListener('dragover', handleDragOver);
                        card.addEventListener('drop', handleDrop);
                        card.classList.add('draggable');
                    }
                    container.appendChild(card);
                }
            });

            if(isAdmin) {
                const addBtn = document.createElement('div');
                addBtn.className = 'add-widget-btn';
                addBtn.innerHTML = '<span>+</span> Ajouter';
                addBtn.onclick = openAddWidget;
                container.appendChild(addBtn);
            }
        }

        // --- HELPER: SCOPE BADGE ---
        function getScopeBadge(scope) {
            if(!scope) return '';
            const labels = { global: 'GLO', regional: 'REG', local: 'LOC' };
            return `<span class="scope-badge scope-${scope}">${labels[scope]}</span>`;
        }

        // --- DASHBOARD DRAG & DROP ---
        function handleDragStart(e) {
            this.style.opacity = '0.4'; dragSrcEl = this;
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML);
        }
        function handleDragOver(e) { if (e.preventDefault) e.preventDefault(); e.dataTransfer.dropEffect = 'move'; return false; }
        function handleDrop(e) {
            if (e.stopPropagation) e.stopPropagation();
            if (dragSrcEl !== this) {
                const srcIdx = parseInt(dragSrcEl.dataset.index);
                const targetIdx = parseInt(this.dataset.index);
                const item = appData.dashboardWidgets.splice(srcIdx, 1)[0];
                appData.dashboardWidgets.splice(targetIdx, 0, item);
                saveData();
            }
            return false;
        }

        // --- WIDGET LOGIC ---
        function openAddWidget() {
            document.getElementById('widgetArticleSelect').innerHTML = appData.articles.map(a => `<option value="${a.id}">${a.title}</option>`).join('');
            document.getElementById('widgetContactSelect').innerHTML = appData.contacts.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            toggleWidgetFields();
            openModal('widgetModal');
        }

        function toggleWidgetFields() {
            const type = document.getElementById('widgetType').value;
            document.getElementById('fieldWidgetArticle').classList.toggle('hidden', type !== 'article');
            document.getElementById('fieldWidgetContact').classList.toggle('hidden', type !== 'contact');
            document.getElementById('fieldWidgetLink').classList.toggle('hidden', type !== 'link');
        }

        function saveWidget() {
            const type = document.getElementById('widgetType').value;
            let widget = { id: 'w'+Date.now(), type, scope: 'local' }; // Default widget scope
            if(type === 'article') widget.contentId = document.getElementById('widgetArticleSelect').value;
            else if (type === 'contact') widget.contentId = document.getElementById('widgetContactSelect').value;
            else if (type === 'link') {
                widget.title = document.getElementById('widgetLinkTitle').value;
                widget.url = document.getElementById('widgetLinkUrl').value;
            }
            appData.dashboardWidgets.push(widget);
            saveData(); closeModal('widgetModal');
        }

        function deleteWidget(index) {
            if(confirm("Retirer ce widget ?")) { appData.dashboardWidgets.splice(index, 1); saveData(); }
        }

        // --- GRID RENDER ---
        function renderSidebar() {
            const container = document.getElementById('categoryNav');
            container.innerHTML = '';
            appData.categories.forEach(cat => {
                const btn = document.createElement('button');
                btn.className = `nav-btn ${filterCatId === cat.id && !filterSubCatId ? 'active' : ''}`;
                btn.onclick = (e) => { switchView('grid'); filterGrid(cat.id, null, e.currentTarget); };
                btn.innerHTML = `<div class="category-dot" style="background:${cat.color}"></div>${cat.name}`;
                container.appendChild(btn);

                if(cat.subcategories && cat.subcategories.length > 0) {
                    cat.subcategories.forEach(sub => {
                        const subBtn = document.createElement('button');
                        subBtn.className = `nav-btn sub-item ${filterSubCatId === sub.id ? 'active' : ''}`;
                        subBtn.innerText = sub.name;
                        subBtn.onclick = (e) => { switchView('grid'); filterGrid(cat.id, sub.id, e.currentTarget); };
                        container.appendChild(subBtn);
                    });
                }
            });
        }

        function filterGrid(catId, subCatId, btn) {
            filterCatId = catId; filterSubCatId = subCatId;
            document.querySelectorAll('.sidebar .nav-btn').forEach(b => b.classList.remove('active'));
            if(btn) btn.classList.add('active');
            renderGrid();
        }

        function renderGrid() {
            const grid = document.getElementById('grid');
            grid.innerHTML = '';
            const query = document.getElementById('searchInput').value.toLowerCase();
            const filtered = appData.articles.filter(item => {
                const catMatch = filterCatId === 'all' || item.catId === filterCatId;
                const subCatMatch = !filterSubCatId || item.subCatId === filterSubCatId;
                return catMatch && subCatMatch && item.title.toLowerCase().includes(query);
            });

            filtered.forEach(item => {
                const cat = appData.categories.find(c => c.id === item.catId) || { name: '...', color: '#ccc' };
                const subCat = cat.subcategories ? cat.subcategories.find(s => s.id === item.subCatId) : null;
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <div class="card-header">
                        <span class="badge" style="background:${cat.color}20; color:${cat.color}">${cat.name}</span>
                        ${subCat ? `<span class="badge" style="background:#f1f2f6; color:#888">${subCat.name}</span>` : ''}
                    </div>
                    <h3>${getScopeBadge(item.scope)} ${item.type === 'tree' ? 'üå≥ ' : ''}${item.title}</h3>
                    <p>${item.type === 'tree' ? 'Arbre de d√©cision interactif.' : (item.blocks?.[0]?.content?.substring(0,80) || '...')}</p>
                    ${isAdmin ? `<div style="margin-top:auto; display:flex; justify-content:flex-end; gap:10px;"><button class="btn-icon danger" onclick="deleteArticle('${item.id}', event)">üóë</button><button class="btn-icon" onclick="openEditor('${item.id}', event)">‚úé</button></div>` : ''}
                `;
                card.onclick = (e) => { if(!e.target.closest('button')) openReader(item); };
                grid.appendChild(card);
            });
        }

        // --- DIRECTORY RENDER ---
        function renderDirectory() {
            const grid = document.getElementById('contactGrid');
            grid.innerHTML = '';
            const query = document.getElementById('searchInput').value.toLowerCase();
            const filtered = appData.contacts.filter(c => c.name.toLowerCase().includes(query));

            filtered.forEach(c => {
                const cat = appData.contactCategories.find(cc => cc.id === c.catId);
                const card = document.createElement('div');
                card.className = 'contact-card';
                card.innerHTML = `
                    <div class="contact-avatar">
                        ${c.name.substring(0,2).toUpperCase()}
                        ${c.scope ? `<div style="position:absolute; bottom:-5px; right:-5px; font-size:10px;">${getScopeBadge(c.scope)}</div>` : ''}
                    </div>
                    <div style="flex:1;">
                        <h4 style="font-size:1rem; font-weight:700;">${c.name}</h4>
                        <div style="font-size:0.8rem; color:var(--text-muted);">${cat?.name||''}</div>
                        ${c.fields.slice(0,2).map(f => `<div style="font-size:0.85rem; color:var(--text-dark); margin-top:2px;"><b>${f.label}:</b> ${f.value}</div>`).join('')}
                    </div>
                    ${isAdmin ? `<button onclick="openContactEditor('${c.id}')" class="btn-icon">‚úé</button>` : ''}
                `;
                grid.appendChild(card);
            });
        }

        // --- UTILS & EDITOR CORE ---
        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        function parseMarkdown(t) { if(!t)return''; return t.replace(/\*\*(.*?)\*\*/g,'<b>$1</b>').replace(/\[(.*?)\]\((.*?)\)/g,'<a href="$2" target="_blank">$1</a>').replace(/\n/g,'<br>'); }

        // --- EDITOR FUNCTIONS (Condensed) ---
        function openEditor(id=null, e=null) {
            if(e) e.stopPropagation();
            currentEditId = id;
            editingContext = 'admin'; // Context is Admin
            
            const catSelect = document.getElementById('editCat');
            catSelect.innerHTML = appData.categories.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            
            document.getElementById('editorBlocks').innerHTML = '';
            treeNodes = []; 

            if(id) {
                const item = appData.articles.find(a => a.id === id);
                document.getElementById('editTitle').value = item.title;
                catSelect.value = item.catId;
                updateSubCatSelect();
                if(item.subCatId) document.getElementById('editSubCat').value = item.subCatId;
                document.getElementById('editScope').value = item.scope || 'local';
                
                setEditorType(item.type || 'standard');
                if(item.type === 'standard') item.blocks.forEach(b => renderBlockInput(b));
                else { treeNodes = JSON.parse(JSON.stringify(item.nodes)); renderVisualTree(); }
            } else {
                document.getElementById('editTitle').value = '';
                document.getElementById('editScope').value = 'local';
                updateSubCatSelect();
                setEditorType('standard');
                renderBlockInput({type:'text', content:''});
                treeNodes=[{id:'start', x:100, y:100, text:'D√©part', choices:[]}]; renderVisualTree();
            }
            openModal('editorModal');
        }

        function setEditorType(type) {
            editorMode = type;
            document.querySelectorAll('#typeStandard, #typeTree').forEach(b => {
                 b.classList.remove('btn-primary'); b.classList.add('btn-secondary');
            });
            const activeBtn = type === 'standard' ? document.getElementById('typeStandard') : document.getElementById('typeTree');
            activeBtn.classList.remove('btn-secondary'); activeBtn.classList.add('btn-primary');
            
            document.getElementById(type === 'standard' ? 'editorStandard' : 'editorTree').classList.remove('hidden');
            document.getElementById(type === 'standard' ? 'editorTree' : 'editorStandard').classList.add('hidden');
        }

        function updateSubCatSelect() {
            const catId = document.getElementById('editCat').value;
            const subSelect = document.getElementById('editSubCat');
            const cat = appData.categories.find(c => c.id === catId);
            subSelect.innerHTML = '<option value="">(Aucune)</option>';
            if(cat && cat.subcategories && cat.subcategories.length > 0) {
                subSelect.style.display = 'block';
                cat.subcategories.forEach(sub => subSelect.innerHTML += `<option value="${sub.id}">${sub.name}</option>`);
            } else { subSelect.style.display = 'none'; }
        }

        function saveArticle() {
            const title = document.getElementById('editTitle').value;
            const catId = document.getElementById('editCat').value;
            const subCatId = document.getElementById('editSubCat').value;
            const scope = document.getElementById('editScope').value;
            if(!title) return alert('Titre requis');

            // Force save tree props if panel is open, just in case
            if(document.getElementById('nodePropsPanel').style.display !== 'none') saveProps();

            let newItem = { 
                id: currentEditId || Date.now().toString(), 
                title, catId, subCatId, scope, type: editorMode 
            };
            
            if(editorMode === 'standard') {
                newItem.blocks = Array.from(document.querySelectorAll('.block-wrapper')).map(el => ({
                    type: el.dataset.type,
                    variant: el.dataset.variant || (el.querySelector('.link-label')?.value),
                    content: el.querySelector('.block-input')?.value || el.querySelector('img')?.src || ''
                })).filter(b => b.content);
            } else { newItem.nodes = treeNodes; }

            if(currentEditId) appData.articles[appData.articles.findIndex(a=>a.id===currentEditId)] = newItem;
            else appData.articles.push(newItem);
            saveData(); closeModal('editorModal');
        }

        function renderBlockInput(b) {
            const div = document.createElement('div'); div.className = 'block-wrapper'; div.dataset.type = b.type;
            div.draggable = true; // Enable drag
            div.addEventListener('dragstart', handleBlockDragStart);
            div.addEventListener('dragover', handleBlockDragOver);
            div.addEventListener('drop', handleBlockDrop);

            if(b.variant) div.dataset.variant = b.variant;
            let html = `<textarea class="input-std block-input" rows="2">${b.content||''}</textarea>`;
            if(b.type==='image') html = `<input type="file" onchange="const f=this.files[0];if(f){const r=new FileReader();r.onload=e=>this.nextElementSibling.src=e.target.result;r.readAsDataURL(f);}"><img src="${b.content||''}" style="max-height:100px;display:block;margin-top:5px;">`;
            if(b.type==='link') html = `<input type="text" class="input-std link-label" value="${b.variant||''}" placeholder="Titre"><input type="text" class="input-std block-input" value="${b.content||''}" placeholder="URL" style="margin-top:5px;">`;
            if(b.type==='contact') {
                const options = appData.contacts.map(c => `<option value="${c.id}" ${c.id === b.content ? 'selected' : ''}>${c.name}</option>`).join('');
                html = `<select class="input-std block-input"><option value="">S√©lectionner un contact...</option>${options}</select>`;
            }

            div.innerHTML = `
                <div class="block-handle">‚ãÆ‚ãÆ</div>
                <div class="block-type-label" style="display:flex;justify-content:space-between;margin-bottom:5px;font-size:0.7rem;font-weight:700;">${b.type.toUpperCase()}<span onclick="this.parentElement.parentElement.remove()" style="cursor:pointer;color:red;">Supprimer</span></div>
                ${html}
            `;
            document.getElementById('editorBlocks').appendChild(div);
        }
        function addBlock(t,v) { renderBlockInput({type:t, variant:v, content:''}); }
        function deleteArticle(id, e) { e.stopPropagation(); if(confirm('Supprimer ?')){ appData.articles=appData.articles.filter(a=>a.id!==id); saveData(); } }

        // --- BLOCK DRAG & DROP ---
        function handleBlockDragStart(e) { blockDragSrc = this; e.dataTransfer.effectAllowed = 'move'; this.classList.add('dragging'); }
        function handleBlockDragOver(e) { if (e.preventDefault) e.preventDefault(); e.dataTransfer.dropEffect = 'move'; return false; }
        function handleBlockDrop(e) {
            if (e.stopPropagation) e.stopPropagation();
            if (blockDragSrc !== this) {
                // DOM Swap
                const container = document.getElementById('editorBlocks');
                const all = Array.from(container.children);
                const srcIndex = all.indexOf(blockDragSrc);
                const tgtIndex = all.indexOf(this);
                
                if (srcIndex < tgtIndex) {
                    this.after(blockDragSrc);
                } else {
                    this.before(blockDragSrc);
                }
            }
            blockDragSrc.classList.remove('dragging');
            return false;
        }

        // --- TREE VISUAL EDITOR (ADMIN) ---
        function renderVisualTree() {
            const container = document.getElementById('nodesLayer'); container.innerHTML = '';
            document.getElementById('connectionsLayer').innerHTML = `<defs><marker id="arrowhead" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="#cbd5e1" /></marker></defs>`;
            treeNodes.forEach(node => {
                const el = document.createElement('div'); 
                el.style.cssText = `position:absolute; left:${node.x}px; top:${node.y}px; background:white; padding:15px; border-radius:12px; box-shadow:0 4px 6px rgba(0,0,0,0.1); border:1px solid #e5e7eb; width:220px; font-size:0.9rem; cursor:move; z-index:10;`;
                if(node.id === 'start') el.style.borderTop = "4px solid var(--primary)";
                el.innerHTML = `<strong>${node.id}</strong><p style="margin-top:5px;color:#666;">${node.text?.substring(0,30)||'...'}</p>`;
                el.onmousedown = (e) => startNodeDrag(e, node.id); 
                el.ondblclick = (e) => { e.stopPropagation(); openNodeProps(node.id, 'admin'); };
                container.appendChild(el);
                if(node.choices) node.choices.forEach(c => { if(c.targetNode) drawArrow(node, treeNodes.find(n=>n.id===c.targetNode), 'connectionsLayer'); });
            });
        }
        
        function drawArrow(src, tgt, layerId) { 
             if(!src||!tgt)return; 
             const p = document.createElementNS("http://www.w3.org/2000/svg", "path"); 
             p.setAttribute("d", `M ${src.x+220} ${src.y+40} C ${src.x+270} ${src.y+40}, ${tgt.x-50} ${tgt.y+40}, ${tgt.x} ${tgt.y+40}`); 
             p.setAttribute("stroke", "#cbd5e1"); p.setAttribute("stroke-width", "2"); p.setAttribute("fill", "none"); p.setAttribute("marker-end", "url(#arrowhead)"); 
             document.getElementById(layerId).appendChild(p); 
        }
        
        // --- TREE VISUAL EDITOR (WIZARD) ---
        function renderWizardTree() {
            const container = document.getElementById('subNodesLayer'); container.innerHTML = '';
            document.getElementById('subConnectionsLayer').innerHTML = `<defs><marker id="arrowhead" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="#cbd5e1" /></marker></defs>`;
            subTreeNodes.forEach(node => {
                const el = document.createElement('div'); 
                el.style.cssText = `position:absolute; left:${node.x}px; top:${node.y}px; background:white; padding:15px; border-radius:12px; box-shadow:0 4px 6px rgba(0,0,0,0.1); border:1px solid #e5e7eb; width:220px; font-size:0.9rem; cursor:move; z-index:10;`;
                if(node.id === 'start') el.style.borderTop = "4px solid var(--primary)";
                el.innerHTML = `<strong>${node.id}</strong><p style="margin-top:5px;color:#666;">${node.text?.substring(0,30)||'...'}</p>`;
                el.onmousedown = (e) => startWizardNodeDrag(e, node.id); 
                el.ondblclick = (e) => { e.stopPropagation(); openNodeProps(node.id, 'wizard'); };
                container.appendChild(el);
                if(node.choices) node.choices.forEach(c => { if(c.targetNode) drawArrow(node, subTreeNodes.find(n=>n.id===c.targetNode), 'subConnectionsLayer'); });
            });
        }
        
        function addWizardNode() { subTreeNodes.push({id:'n'+Date.now().toString().slice(-4), x:150, y:150, text:'?', choices:[]}); renderWizardTree(); }

        // --- COMMON NODE PROPS ---
        function openNodeProps(id, context) { 
            const nodesList = context === 'wizard' ? subTreeNodes : treeNodes;
            const n = nodesList.find(n => n.id === id); 
            if(!n) return;
            
            document.getElementById('propNodeId').value = id; 
            document.getElementById('propNodeText').value = n.text || '';
            document.getElementById('nodePropsPanel').style.display = 'block'; 
            renderPropChoices(n); 
        }
        
        function renderPropChoices(n) {
            const list = document.getElementById('propChoicesList'); list.innerHTML = '';
            
            // Determine which node list to use for targets
            const nodesList = (editingContext === 'wizard') ? subTreeNodes : treeNodes;
            const targets = nodesList.map(x => `<option value="${x.id}">${x.id}</option>`).join('');
            const articlesOpts = '<option value="">(Aucune fiche li√©e)</option>' + appData.articles.map(a => `<option value="${a.id}">${a.title}</option>`).join('');

            (n.choices||[]).forEach((c, i) => {
                const div = document.createElement('div');
                div.style.cssText = "margin-bottom:10px; padding:10px; background:#f3f4f6; border-radius:8px;";
                div.innerHTML = `
                    <input class="input-std p-lbl" value="${c.label}" placeholder="R√©ponse" style="margin-bottom:5px;" onchange="saveProps()">
                    <select class="input-std p-tgt" onchange="saveProps()"><option value="">(Fin)</option>${targets}</select>
                    <select class="input-std p-art" style="margin-top:5px;font-size:0.8rem;color:var(--secondary);" onchange="saveProps()">${articlesOpts}</select>
                    <button class="btn-icon danger" style="width:100%; height:20px; margin-top:5px; border-radius:4px;">x</button>
                `;
                // Set values
                div.querySelector('.p-tgt').value = c.targetNode || '';
                div.querySelector('.p-art').value = c.linkedArtId || '';
                div.querySelector('.btn-icon').onclick = () => { n.choices.splice(i, 1); saveProps(); renderPropChoices(n); };
                list.appendChild(div);
            });
        }
        
        function addPropChoice() { 
            const nodesList = (editingContext === 'wizard') ? subTreeNodes : treeNodes;
            const n = nodesList.find(x => x.id == document.getElementById('propNodeId').value); 
            if(!n.choices) n.choices = []; 
            n.choices.push({label:'R√©ponse'}); 
            renderPropChoices(n); saveProps(); 
        }
        
        function saveProps() { 
            const nodesList = (editingContext === 'wizard') ? subTreeNodes : treeNodes;
            const n = nodesList.find(x => x.id == document.getElementById('propNodeId').value); 
            if(n) { 
                n.text = document.getElementById('propNodeText').value; 
                n.choices = Array.from(document.querySelectorAll('#propChoicesList > div')).map(d => ({ 
                    label:d.querySelector('.p-lbl').value, 
                    targetNode:d.querySelector('.p-tgt').value,
                    linkedArtId:d.querySelector('.p-art').value
                })); 
                if(editingContext === 'wizard') renderWizardTree(); else renderVisualTree();
            } 
        }
        
        function closeNodeProps() { document.getElementById('nodePropsPanel').style.display = 'none'; saveProps(); }
        function addVisualNode() { treeNodes.push({id:'n'+Date.now().toString().slice(-4), x:150, y:150, text:'?', choices:[]}); renderVisualTree(); }
        function deleteVisualNode() { 
            const id = document.getElementById('propNodeId').value; 
            if(id !== 'start') { 
                if(editingContext === 'wizard') {
                    subTreeNodes = subTreeNodes.filter(n => n.id !== id);
                    closeNodeProps(); renderWizardTree();
                } else {
                    treeNodes = treeNodes.filter(n => n.id !== id); 
                    closeNodeProps(); renderVisualTree(); 
                }
            } 
        }
        
        // --- DRAG HANDLERS (ADMIN) ---
        function startCanvasDrag(e) { if(e.target.closest('div')) return; isPanning=true; startPan={x:e.clientX-canvasTranslate.x, y:e.clientY-canvasTranslate.y}; document.addEventListener('mousemove', onCanvasDrag); document.addEventListener('mouseup', endCanvasDrag); }
        function onCanvasDrag(e) { if(!isPanning)return; canvasTranslate.x=e.clientX-startPan.x; canvasTranslate.y=e.clientY-startPan.y; applyCanvasTransform('canvasLayer'); }
        function endCanvasDrag() { isPanning=false; document.removeEventListener('mousemove', onCanvasDrag); document.removeEventListener('mouseup', endCanvasDrag); }
        function startNodeDrag(e, id) { e.stopPropagation(); draggedNode=treeNodes.find(n=>n.id===id); dragOffset.x=e.clientX-draggedNode.x; dragOffset.y=e.clientY-draggedNode.y; document.addEventListener('mousemove', onNodeDrag); document.addEventListener('mouseup', endNodeDrag); }
        function onNodeDrag(e) { if(!draggedNode)return; draggedNode.x=e.clientX-dragOffset.x; draggedNode.y=e.clientY-dragOffset.y; renderVisualTree(); }
        function endNodeDrag() { draggedNode=null; document.removeEventListener('mousemove', onNodeDrag); document.removeEventListener('mouseup', endNodeDrag); }
        function handleZoom(e) { e.preventDefault(); canvasScale+=e.deltaY>0?-0.1:0.1; canvasScale=Math.max(0.5, Math.min(2,canvasScale)); applyCanvasTransform('canvasLayer'); }
        
        // --- DRAG HANDLERS (WIZARD) ---
        function startWizardCanvasDrag(e) { if(e.target.closest('div')) return; isPanning=true; startPan={x:e.clientX-canvasTranslate.x, y:e.clientY-canvasTranslate.y}; document.addEventListener('mousemove', onWizardCanvasDrag); document.addEventListener('mouseup', endWizardCanvasDrag); }
        function onWizardCanvasDrag(e) { if(!isPanning)return; canvasTranslate.x=e.clientX-startPan.x; canvasTranslate.y=e.clientY-startPan.y; applyCanvasTransform('subCanvasLayer'); }
        function endWizardCanvasDrag() { isPanning=false; document.removeEventListener('mousemove', onWizardCanvasDrag); document.removeEventListener('mouseup', endWizardCanvasDrag); }
        function startWizardNodeDrag(e, id) { e.stopPropagation(); draggedNode=subTreeNodes.find(n=>n.id===id); dragOffset.x=e.clientX-draggedNode.x; dragOffset.y=e.clientY-draggedNode.y; document.addEventListener('mousemove', onWizardNodeDrag); document.addEventListener('mouseup', endWizardNodeDrag); }
        function onWizardNodeDrag(e) { if(!draggedNode)return; draggedNode.x=e.clientX-dragOffset.x; draggedNode.y=e.clientY-dragOffset.y; renderWizardTree(); }
        function endWizardNodeDrag() { draggedNode=null; document.removeEventListener('mousemove', onWizardNodeDrag); document.removeEventListener('mouseup', endWizardNodeDrag); }
        function handleWizardZoom(e) { e.preventDefault(); canvasScale+=e.deltaY>0?-0.1:0.1; canvasScale=Math.max(0.5, Math.min(2,canvasScale)); applyCanvasTransform('subCanvasLayer'); }

        function applyCanvasTransform(layerId) { document.getElementById(layerId).style.transform = `scale(${canvasScale}) translate(${canvasTranslate.x}px, ${canvasTranslate.y}px)`; }

        // --- CONTACTS ---
        function openContactEditor(id=null) {
            document.getElementById('contactCat').innerHTML = appData.contactCategories.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            document.getElementById('contactFields').innerHTML = '';
            if(id) {
                const c = appData.contacts.find(x => x.id===id); 
                document.getElementById('contactId').value=c.id; 
                document.getElementById('contactName').value=c.name;
                document.getElementById('contactScope').value=c.scope || 'local';
                c.fields.forEach(f => addContactField(f.label, f.value));
            } else { 
                document.getElementById('contactId').value=''; 
                document.getElementById('contactName').value=''; 
                document.getElementById('contactScope').value='local';
                addContactField('Tel',''); 
            }
            openModal('contactModal');
        }
        function addContactField(l='', v='') { document.getElementById('contactFields').innerHTML += `<div style="display:flex;gap:5px;margin-bottom:5px;"><input class="input-std f-lbl" value="${l}" placeholder="Label"><input class="input-std f-val" value="${v}" placeholder="Valeur"><button onclick="this.parentElement.remove()" class="btn-icon danger">√ó</button></div>`; }
        function saveContact() {
            const id = document.getElementById('contactId').value;
            const c = { 
                id: id||Date.now().toString(), 
                name: document.getElementById('contactName').value, 
                catId: document.getElementById('contactCat').value, 
                scope: document.getElementById('contactScope').value,
                fields: Array.from(document.querySelectorAll('#contactFields > div')).map(d=>({label:d.querySelector('.f-lbl').value, value:d.querySelector('.f-val').value})) 
            };
            if(id) appData.contacts[appData.contacts.findIndex(x=>x.id===id)] = c; else appData.contacts.push(c);
            saveData(); closeModal('contactModal');
        }
        function deleteContact() { if(confirm('Supprimer ?')) { appData.contacts=appData.contacts.filter(c=>c.id!==document.getElementById('contactId').value); saveData(); closeModal('contactModal'); } }

        // --- READER (Enhanced with Collection) ---
        function openReader(item) {
            currentReadArticle = item;
            const cat = appData.categories.find(c => c.id === item.catId);
            document.getElementById('readCat').innerText = cat ? cat.name : 'Info';
            document.getElementById('readCat').style.color = cat ? cat.color : '#888';
            document.getElementById('readCat').style.background = cat ? cat.color + '20' : '#eee';
            
            const ct = document.getElementById('readContent'); ct.innerHTML = `<h1>${item.title} ${getScopeBadge(item.scope)}</h1>`;
            
            if(item.type === 'standard') {
                renderReaderBlocks(item.blocks, ct);
            } else {
                renderTreeEngine(item, ct);
            }
            openModal('readerModal');
        }

        function renderReaderBlocks(blocks, container) {
             blocks.forEach(b => {
                if(b.type==='text') container.innerHTML += `<p class="reader-block">${parseMarkdown(b.content)}</p>`;
                if(b.type==='alert') container.innerHTML += `<div class="reader-alert"><span>‚ö†Ô∏è</span><div>${parseMarkdown(b.content)}</div></div>`;
                if(b.type==='step') container.innerHTML += `<div style="display:flex;gap:15px;margin-bottom:1rem;align-items:center;"><div class="step-circle">${Array.from(container.querySelectorAll('.step-circle')).length+1}</div><div>${parseMarkdown(b.content)}</div></div>`;
                if(b.type==='image') container.innerHTML += `<img src="${b.content}" style="max-width:100%;border-radius:12px;margin-bottom:1rem;">`;
                if(b.type==='link') container.innerHTML += `<a href="${b.content}" target="_blank" style="display:block;padding:1rem;background:#f1f2f6;border-radius:12px;text-decoration:none;color:var(--primary);font-weight:700;">üîó ${b.variant || 'Lien externe'}</a>`;
                if(b.type==='contact') {
                    const c = appData.contacts.find(x => x.id === b.content);
                    if(c) {
                        const cat = appData.contactCategories.find(cc => cc.id === c.catId);
                        const fieldsHtml = c.fields.map(f => `<div style="font-size:0.85rem;color:#4b6584;"><b>${f.label}:</b> ${f.value}</div>`).join('');
                        container.innerHTML += `
                        <div class="linked-contact-box" style="margin:1rem 0;">
                            <div class="linked-contact-avatar">${c.name.substring(0,2).toUpperCase()}</div>
                            <div>
                                <div style="font-weight:700;color:var(--text-dark);">${c.name}</div>
                                <div style="font-size:0.8rem;color:var(--text-muted);margin-bottom:2px;">${cat?.name||'Contact'}</div>
                                ${fieldsHtml}
                            </div>
                        </div>`;
                    }
                }
            });
        }

        function renderTreeEngine(item, container) {
            let current = 'start', history = [], collectedArticles = [];
            const view = document.createElement('div'); container.appendChild(view);
            
            const renderNode = () => {
                const node = item.nodes.find(n => n.id === current);
                if(!node) {
                    // END OF TREE - RENDER COLLECTED REPORT
                    let html = `<div style="padding:2rem;text-align:center;background:#ecfdf5;color:#065f46;border-radius:12px;margin-bottom:2rem;"><h3>Fin du parcours</h3><p>Voici les protocoles compil√©s selon vos r√©ponses.</p></div>`;
                    if(collectedArticles.length > 0) {
                        collectedArticles.forEach(artId => {
                            const art = appData.articles.find(a => a.id === artId);
                            if(art) {
                                html += `<div style="border:1px solid #eee; border-radius:16px; padding:1.5rem; margin-bottom:1.5rem; background:white;">
                                    <h3 style="color:var(--primary); margin-bottom:1rem;">${art.title}</h3>
                                    <div id="compiled-${art.id}"></div>
                                </div>`;
                            }
                        });
                    } else {
                        html += `<p style="text-align:center;color:#888;">Aucune fiche sp√©cifique associ√©e aux choix effectu√©s.</p>`;
                    }
                    html += `<button onclick="closeModal('readerModal')" class="btn-secondary" style="width:100%;margin-top:1rem;">Fermer</button>`;
                    view.innerHTML = html;
                    
                    // Render blocks into the placeholders
                    collectedArticles.forEach(artId => {
                         const art = appData.articles.find(a => a.id === artId);
                         if(art && art.blocks) {
                             const div = document.getElementById(`compiled-${art.id}`);
                             renderReaderBlocks(art.blocks, div);
                         }
                    });
                    return;
                }

                let html = `<h2 style="margin-bottom:2rem;">${node.text}</h2><div style="display:grid;gap:1rem;">`;
                (node.choices||[]).forEach(c => html += `<button class="tree-btn" onclick="next('${c.targetNode}', '${c.linkedArtId}')">${c.label}</button>`);
                html += `</div>${history.length ? `<button onclick="back()" style="margin-top:2rem;border:none;background:none;color:#888;cursor:pointer;">‚Üê Retour</button>` : ''}`;
                view.innerHTML = html;
            };

            window.next = (id, linkedArtId) => { 
                if(linkedArtId && linkedArtId !== 'undefined') collectedArticles.push(linkedArtId);
                if(id) { history.push(current); current=id; renderNode(); } 
                else { current = null; renderNode(); } // End
            };
            window.back = () => { current=history.pop(); collectedArticles.pop(); renderNode(); };
            renderNode();
        }

        // --- SETTINGS & IMPORT/EXPORT (Tiered) ---
        function openSettings() {
            // Render Articles Categories (Advanced)
            const list = document.getElementById('catListEdit');
            list.innerHTML = '';
            
            appData.categories.forEach(c => {
                // Main Category Row
                const group = document.createElement('div');
                group.className = 'cat-group';
                
                const catRow = document.createElement('div');
                catRow.className = 'cat-row';
                catRow.innerHTML = `
                    <input type="color" value="${c.color}" onchange="appData.categories.find(x=>x.id=='${c.id}').color=this.value;saveData();" style="border:none;background:none;width:30px;cursor:pointer;">
                    <input type="text" value="${c.name}" onchange="appData.categories.find(x=>x.id=='${c.id}').name=this.value;saveData();">
                    <button class="btn-ghost" onclick="toggleSubCatView('${c.id}')" style="font-size:0.8rem;">Sous-cat√©gories</button>
                    <button onclick="if(confirm('Supprimer cette cat√©gorie ?')){appData.categories=appData.categories.filter(x=>x.id!=='${c.id}');saveData();openSettings();}" class="btn-icon danger">√ó</button>
                `;
                group.appendChild(catRow);
                
                // Subcats Container
                const subCont = document.createElement('div');
                subCont.id = `subcat-list-${c.id}`;
                subCont.className = 'subcat-container';
                
                // Existing subcats
                if(c.subcategories) {
                    c.subcategories.forEach(sc => {
                        const scRow = document.createElement('div');
                        scRow.className = 'subcat-row';
                        scRow.innerHTML = `
                            <span>‚Ü≥</span>
                            <input type="text" value="${sc.name}" onchange="updateSubCatName('${c.id}', '${sc.id}', this.value)">
                            <button onclick="deleteSubCategory('${c.id}', '${sc.id}')" class="btn-icon danger" style="width:24px;height:24px;font-size:0.8rem;">√ó</button>
                        `;
                        subCont.appendChild(scRow);
                    });
                }
                
                // Add Subcat Row
                const addRow = document.createElement('div');
                addRow.className = 'subcat-row';
                addRow.innerHTML = `
                    <span>+</span>
                    <input type="text" placeholder="Ajouter sous-cat√©gorie..." onkeydown="if(event.key==='Enter') addSubCategory('${c.id}', this.value)">
                `;
                subCont.appendChild(addRow);
                
                group.appendChild(subCont);
                list.appendChild(group);
            });
            
            // Render Contact Categories (Simple)
            document.getElementById('contactCatListEdit').innerHTML = appData.contactCategories.map(c => `<div class="settings-row"><input type="text" value="${c.name}" onchange="appData.contactCategories.find(x=>x.id=='${c.id}').name=this.value;saveData();"><button onclick="if(confirm('Suppr?')){appData.contactCategories=appData.contactCategories.filter(x=>x.id!=='${c.id}');saveData();openSettings();}" class="btn-icon danger">√ó</button></div>`).join('');
            
            openModal('settingsModal');
        }
        
        // --- SUBCATEGORY HELPERS ---
        function toggleSubCatView(catId) {
            document.getElementById(`subcat-list-${catId}`).classList.toggle('open');
        }
        
        function updateSubCatName(catId, subId, newName) {
            const cat = appData.categories.find(c => c.id === catId);
            const sub = cat.subcategories.find(s => s.id === subId);
            if(sub) { sub.name = newName; saveData(); }
        }
        
        function addSubCategory(catId, name) {
            if(!name.trim()) return;
            const cat = appData.categories.find(c => c.id === catId);
            if(cat) {
                if(!cat.subcategories) cat.subcategories = [];
                cat.subcategories.push({ id: Date.now().toString(), name: name });
                saveData();
                openSettings(); // Refresh
                setTimeout(() => toggleSubCatView(catId), 50); // Re-open
            }
        }
        
        function deleteSubCategory(catId, subId) {
            const cat = appData.categories.find(c => c.id === catId);
            if(cat && confirm("Supprimer cette sous-cat√©gorie ?")) {
                cat.subcategories = cat.subcategories.filter(s => s.id !== subId);
                saveData();
                openSettings();
                setTimeout(() => toggleSubCatView(catId), 50);
            }
        }

        function addCategory(t) { 
            if(t==='article') {
                const n = document.getElementById('newCatName'); if(!n.value) return;
                appData.categories.push({id:Date.now().toString(), name:n.value, color:document.getElementById('newCatColor').value, subcategories:[], scope:'local'});
                n.value='';
            } else {
                const n = document.getElementById('newContactCatName'); if(!n.value) return;
                appData.contactCategories.push({id:Date.now().toString(), name:n.value});
                n.value='';
            }
            saveData(); openSettings();
        }

        function exportDatabase(scope) {
            let exportData = {};
            if(scope === 'all') {
                exportData = appData;
            } else {
                // Filter all arrays by scope
                exportData = {
                    categories: appData.categories.filter(x => x.scope === scope),
                    contactCategories: appData.contactCategories, // Always include common meta structure
                    articles: appData.articles.filter(x => x.scope === scope),
                    contacts: appData.contacts.filter(x => x.scope === scope),
                    dashboardWidgets: appData.dashboardWidgets.filter(x => x.scope === scope),
                    dashboardInfo: appData.dashboardInfo,
                    submissions: appData.submissions // Include submissions only in full backup usually, but lets keep it safe
                };
            }
            const name = scope === 'all' ? 'backup_full' : `backup_${scope}`;
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([JSON.stringify(exportData)], {type:'application/json'}));
            a.download = `medibase_${name}.json`;
            a.click();
        }

        function triggerImport(scope) {
            pendingImportScope = scope;
            document.getElementById('dbFileInput').click();
        }

        function processImport(el) {
            const file = el.files[0];
            if(!file) return;
            
            const reader = new FileReader();
            reader.onload = e => {
                try {
                    const imported = JSON.parse(e.target.result);
                    
                    if(pendingImportScope === 'all') {
                        if(confirm("Attention: Cela va √©craser TOUTES les donn√©es actuelles. Continuer ?")) {
                            appData = imported;
                            alert("Restauration compl√®te effectu√©e.");
                        }
                    } else {
                        // Scope based import: Remove existing of that scope, add new
                        const target = pendingImportScope;
                        
                        // 1. Remove old data of this scope
                        appData.categories = appData.categories.filter(x => x.scope !== target);
                        appData.articles = appData.articles.filter(x => x.scope !== target);
                        appData.contacts = appData.contacts.filter(x => x.scope !== target);
                        appData.dashboardWidgets = appData.dashboardWidgets.filter(x => x.scope !== target);

                        // 2. Add new data (and enforce scope just in case)
                        if(imported.categories) imported.categories.forEach(x => { x.scope = target; appData.categories.push(x); });
                        if(imported.articles) imported.articles.forEach(x => { x.scope = target; appData.articles.push(x); });
                        if(imported.contacts) imported.contacts.forEach(x => { x.scope = target; appData.contacts.push(x); });
                        if(imported.dashboardWidgets) imported.dashboardWidgets.forEach(x => { x.scope = target; appData.dashboardWidgets.push(x); });
                        
                        // Merge Contact Categories (deduplicate by name)
                        if(imported.contactCategories) {
                             imported.contactCategories.forEach(ic => {
                                 if(!appData.contactCategories.find(ec => ec.name === ic.name)) {
                                     appData.contactCategories.push(ic);
                                 }
                             });
                        }

                        alert(`Import de la base ${target.toUpperCase()} r√©ussi.`);
                    }

                    saveData();
                    location.reload();
                } catch(err) {
                    alert("Erreur lors de la lecture du fichier.");
                    console.error(err);
                }
                el.value = ''; // Reset input
            };
            reader.readAsText(file);
        }

        init();
    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>